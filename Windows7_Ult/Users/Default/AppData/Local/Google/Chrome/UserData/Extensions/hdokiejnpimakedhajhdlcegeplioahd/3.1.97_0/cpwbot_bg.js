var CPWbot_bg,g_v2engine=!0,g_v3engine=!1;CPWbot_bg||(CPWbot_bg=new CPWbot_bg_lib);
var g_cpw_server_initiated_tabid=null,TYPE_ID="id",TYPE_NAME="name",TYPE_XPATH="xpath",FN_LOGIN=1,FN_PASSWORD=2,FN_LOGIN_OTHER=5,FN_CURRENT_PASS=10,FN_NEW_PASS=11,FN_NEW_PASS_CONFIRM=12,FN_CPW_OTHER=13,FN_CPW_INVALID=14,FN_LOGIN_INVALID=15,FN_LOGIN_SUCCESS=16,FN_LOGIN_SUCCESS_INVALID=17,FN_NAVIGATE_TO_CPW=18,FN_CPW_SUCCESS=19,FN_CPW_SUCCESS_INVALID=20,FN_NAVIGATE_TO_ACCTMGMT=21,FN_CPW_SUBMIT=22,FN_IS_LOGGED_IN=23,FN_IS_LOGGED_IN_NEGATION=24,FN_LOGIN_SUBMIT=25,FN_POPUP_EXISTS=26,FN_POPUP_DISMISS=27,
FN_REVEAL_LOGIN=28,FN_CHALLENGE_LOGIN=29,FN_CHALLENGE_PASSWORD=30,FN_CHALLENGE_OTHER=31,FN_CHALLENGE_SUBMIT=32,FN_CHALLENGE_INVALID=33,FN_CHALLENGE_SUCCESS=34,FN_CHALLENGE_SUCCESS_INVALID=35,FN_EPHEMERAL_STATE=37,FN_NAVIGATE_TO_LOGOUT=38,FN_CAPTCHA=39,FN_MULTI_FACTOR=40,FN_PASSWORD_HINT=41,FN_POPUP_EXISTS_INVALID=42,FN_FAKEUI_LOGGED_OUT_1=43,FN_FAKEUI_LOGGED_OUT_2=44,FN_FAKEUI_LOGGED_OUT_3=45,FN_FAKEUI_LOGGED_OUT_INPUT=46,FN_FAKEUI_LOGGED_IN_1=47,FN_FAKEUI_LOGGED_IN_2=48,FN_FAKEUI_LOGGED_IN_3=49,
FN_FAKEUI_LOGGED_IN_INPUT=50,FN_FORCE_FAIL=51,FN_CAPTCHA_SUCCESS=52,FN_MULTI_FACTOR_SUCCESS=53,FN_PASSWORD_HINT_SUCCESS=54,FN_LOGIN_ENTRY_INVALID=55,FN_LOGIN_ENTRY_USERNAME=56,FN_LOGIN_ENTRY_SUBMIT=57,FN_LOGIN_ENTRY_PASSWORD=58,FN_LOGIN_ENTRY_SUCCESS_INVALID=59,FN_LOGIN_ENTRY_SUCCESS=60,FN_REVEAL_LOGOUT=61,JS_PRE_NAVIGATE_CPW=1,JS_PRE_LOGIN=2,JS_POST_NAVIGATE_CPW=3,JS_POST_LOGIN=4,JS_PRE_CPW=5,JS_POST_CPW=6,JS_PRE_ACCTMGMT=7,JS_POST_ACCTMGMT=8,JS_LOGIN_REVEAL=9,JS_VALIDATE_LOGIN_SUCCESS=10,JS_VALIDATE_CPW_SUCCESS=
11,JS_LOGIN_SUBMIT=12,JS_FINISH=13,JS_PRE_CHALLENGE=14,JS_POST_CHALLENGE=15,JS_CHALLENGE_SUBMIT=16,JS_VALIDATE_CHALLENGE_SUCCESS=17,JS_BEGIN=18,JS_PRE_LOGOUT=19,JS_POST_LOGOUT=20,JS_LOGIN_ENTRY_SUBMIT=21,JS_PRE_LOGIN_ENTRY=22,JS_POST_LOGIN_ENTRY=23,JS_VALIDATE_LOGIN_ENTRY_SUCCESS=24,JS_PRE_DOCAPTCHA=25,JS_POST_DOCAPTCHA=26;
function replace_constants(g){if(!g)return null;if("undefined"!=typeof g.field_info)for(var e=0;e<g.field_info.length;e++){if("undefined"!=typeof g.field_info[e].id_type)switch(g.field_info[e].id_type){case "TYPE_ID":g.field_info[e].id_type=TYPE_ID;break;case "TYPE_NAME":g.field_info[e].id_type=TYPE_NAME;break;case "TYPE_XPATH":g.field_info[e].id_type=TYPE_XPATH}if("undefined"!=typeof g.field_info[e].id_function)switch(g.field_info[e].id_function){case "FN_LOGIN":g.field_info[e].id_function=FN_LOGIN;
break;case "FN_PASSWORD":g.field_info[e].id_function=FN_PASSWORD;break;case "FN_LOGIN_OTHER":g.field_info[e].id_function=FN_LOGIN_OTHER;break;case "FN_CURRENT_PASS":g.field_info[e].id_function=FN_CURRENT_PASS;break;case "FN_NEW_PASS":g.field_info[e].id_function=FN_NEW_PASS;break;case "FN_NEW_PASS_CONFIRM":g.field_info[e].id_function=FN_NEW_PASS_CONFIRM;break;case "FN_CPW_OTHER":g.field_info[e].id_function=FN_CPW_OTHER;break;case "FN_CPW_INVALID":g.field_info[e].id_function=FN_CPW_INVALID;break;case "FN_LOGIN_INVALID":g.field_info[e].id_function=
FN_LOGIN_INVALID;break;case "FN_LOGIN_SUCCESS":g.field_info[e].id_function=FN_LOGIN_SUCCESS;break;case "FN_LOGIN_SUCCESS_INVALID":g.field_info[e].id_function=FN_LOGIN_SUCCESS_INVALID;break;case "FN_NAVIGATE_TO_CPW":g.field_info[e].id_function=FN_NAVIGATE_TO_CPW;break;case "FN_CPW_SUCCESS":g.field_info[e].id_function=FN_CPW_SUCCESS;break;case "FN_CPW_SUCCESS_INVALID":g.field_info[e].id_function=FN_CPW_SUCCESS_INVALID;break;case "FN_NAVIGATE_TO_ACCTMGMT":g.field_info[e].id_function=FN_NAVIGATE_TO_ACCTMGMT;
break;case "FN_CPW_SUBMIT":g.field_info[e].id_function=FN_CPW_SUBMIT;break;case "FN_IS_LOGGED_IN":g.field_info[e].id_function=FN_IS_LOGGED_IN;break;case "FN_IS_LOGGED_IN_NEGATION":g.field_info[e].id_function=FN_IS_LOGGED_IN_NEGATION;break;case "FN_LOGIN_SUBMIT":g.field_info[e].id_function=FN_LOGIN_SUBMIT;break;case "FN_POPUP_EXISTS":g.field_info[e].id_function=FN_POPUP_EXISTS;break;case "FN_POPUP_DISMISS":g.field_info[e].id_function=FN_POPUP_DISMISS;break;case "FN_REVEAL_LOGIN":g.field_info[e].id_function=
FN_REVEAL_LOGIN;break;case "FN_CHALLENGE_LOGIN":g.field_info[e].id_function=FN_CHALLENGE_LOGIN;break;case "FN_CHALLENGE_PASSWORD":g.field_info[e].id_function=FN_CHALLENGE_PASSWORD;break;case "FN_CHALLENGE_OTHER":g.field_info[e].id_function=FN_CHALLENGE_OTHER;break;case "FN_CHALLENGE_SUBMIT":g.field_info[e].id_function=FN_CHALLENGE_SUBMIT;break;case "FN_CHALLENGE_INVALID":g.field_info[e].id_function=FN_CHALLENGE_INVALID;break;case "FN_CHALLENGE_SUCCESS":g.field_info[e].id_function=FN_CHALLENGE_SUCCESS;
break;case "FN_CHALLENGE_SUCCESS_INVALID":g.field_info[e].id_function=FN_CHALLENGE_SUCCESS_INVALID;break;case "FN_NAVIGATE_TO_LOGOUT":g.field_info[e].id_function=FN_NAVIGATE_TO_LOGOUT;break;case "FN_EPHEMERAL_STATE":g.field_info[e].id_function=FN_EPHEMERAL_STATE;break;case "FN_CAPTCHA":g.field_info[e].id_function=FN_CAPTCHA;break;case "FN_MULTI_FACTOR":g.field_info[e].id_function=FN_MULTI_FACTOR;break;case "FN_PASSWORD_HINT":g.field_info[e].id_function=FN_PASSWORD_HINT;break;case "FN_POPUP_EXISTS_INVALID":g.field_info[e].id_function=
FN_POPUP_EXISTS_INVALID;break;case "FN_FORCE_FAIL":g.field_info[e].id_function=FN_FORCE_FAIL;break;case "FN_CAPTCHA_SUCCESS":g.field_info[e].id_function=FN_CAPTCHA_SUCCESS;break;case "FN_MULTI_FACTOR_SUCCESS":g.field_info[e].id_function=FN_MULTI_FACTOR_SUCCESS;break;case "FN_PASSWORD_HINT_SUCCESS":g.field_info[e].id_function=FN_PASSWORD_HINT_SUCCESS;break;case "FN_LOGIN_ENTRY_INVALID":g.field_info[e].id_function=FN_LOGIN_ENTRY_INVALID;break;case "FN_LOGIN_ENTRY_USERNAME":g.field_info[e].id_function=
FN_LOGIN_ENTRY_USERNAME;break;case "FN_LOGIN_ENTRY_PASSWORD":g.field_info[e].id_function=FN_LOGIN_ENTRY_PASSWORD;break;case "FN_LOGIN_ENTRY_SUBMIT":g.field_info[e].id_function=FN_LOGIN_ENTRY_SUBMIT;break;case "FN_LOGIN_ENTRY_SUCCESS":g.field_info[e].id_function=FN_LOGIN_ENTRY_SUCCESS;break;case "FN_LOGIN_ENTRY_SUCCESS_INVALID":g.field_info[e].id_function=FN_LOGIN_ENTRY_SUCCESS_INVALID;break;case "FN_REVEAL_LOGOUT":g.field_info[e].id_function=FN_REVEAL_LOGOUT}}if("undefined"!=typeof g.jsfrags)for(e=
0;e<g.jsfrags.length;e++)if("undefined"!=typeof g.jsfrags[e].jstype)switch(g.jsfrags[e].jstype){case "JS_PRE_NAVIGATE_CPW":g.jsfrags[e].jstype=JS_PRE_NAVIGATE_CPW;break;case "JS_PRE_LOGIN":g.jsfrags[e].jstype=JS_PRE_LOGIN;break;case "JS_POST_NAVIGATE_CPW":g.jsfrags[e].jstype=JS_POST_NAVIGATE_CPW;break;case "JS_POST_LOGIN":g.jsfrags[e].jstype=JS_POST_LOGIN;break;case "JS_PRE_CPW":g.jsfrags[e].jstype=JS_PRE_CPW;break;case "JS_POST_CPW":g.jsfrags[e].jstype=JS_POST_CPW;break;case "JS_PRE_ACCTMGMT":g.jsfrags[e].jstype=
JS_PRE_ACCTMGMT;break;case "JS_POST_ACCTMGMT":g.jsfrags[e].jstype=JS_POST_ACCTMGMT;break;case "JS_LOGIN_REVEAL":g.jsfrags[e].jstype=JS_LOGIN_REVEAL;break;case "JS_VALIDATE_LOGIN_SUCCESS":g.jsfrags[e].jstype=JS_VALIDATE_LOGIN_SUCCESS;break;case "JS_VALIDATE_CPW_SUCCESS":g.jsfrags[e].jstype=JS_VALIDATE_CPW_SUCCESS;break;case "JS_LOGIN_SUBMIT":g.jsfrags[e].jstype=JS_LOGIN_SUBMIT;break;case "JS_FINISH":g.jsfrags[e].jstype=JS_FINISH;break;case "JS_PRE_CHALLENGE":g.jsfrags[e].jstype=JS_PRE_CHALLENGE;break;
case "JS_POST_CHALLENGE":g.jsfrags[e].jstype=JS_POST_CHALLENGE;break;case "JS_CHALLENGE_SUBMIT":g.jsfrags[e].jstype=JS_CHALLENGE_SUBMIT;break;case "JS_VALIDATE_CHALLENGE_SUCCESS":g.jsfrags[e].jstype=JS_VALIDATE_CHALLENGE_SUCCESS;break;case "JS_BEGIN":g.jsfrags[e].jstype=JS_BEGIN;break;case "JS_PRE_LOGOUT":g.jsfrags[e].jstype=JS_PRE_LOGOUT;break;case "JS_POST_LOGOUT":g.jsfrags[e].jstype=JS_POST_LOGOUT;break;case "JS_PRE_LOGIN_ENTRY":g.jsfrags[e].jstype=JS_PRE_LOGIN_ENTRY;break;case "JS_POST_LOGIN_ENTRY":g.jsfrags[e].jstype=
JS_POST_LOGIN_ENTRY;break;case "JS_LOGIN_ENTRY_SUBMIT":g.jsfrags[e].jstype=JS_LOGIN_ENTRY_SUBMIT;break;case "JS_PRE_DOCAPTCHA":g.jsfrags[e].jstype=JS_PRE_DOCAPTCHA;break;case "JS_POST_DOCAPTCHA":g.jsfrags[e].jstype=JS_POST_DOCAPTCHA}return g}
var DEFAULT_CLICK_DELAY=250,DEFAULT_FILL_DELAY=250,DEFAULT_SESSION_TIMEOUT=12E4,DEFAULT_VALIDATE_TIMEOUT=1E4,CLICK_RETRY_TIME=5E3,recipe_template={version:1,symbolic:"",login_url:"",acctmgmt_url:null,cpw_url:"",logout_url:"",login_entry_url:"",validate_timeout:5E3,field_info:[],jsfrags:[],cpw_delay:250,login_delay:250,acctmgmt_delay:250,login_reveal_delay:250,logout_reveal_delay:250,logout_delay:250,fill_field_delay:250,click_field_delay:250,trigger_cpw_delay:0,cpw_change_success_url:null,cpw_change_failure_url:null,
login_failure_url:null,login_success_url:null,login_entry_failure_url:null,login_entry_success_url:null,challenge_invalidate_url:null,challenge_validate_url:null,generate_pref_overrides:null,reveal_login_js_delay:0,reveal_cpw_js_delay:0,navigate_acctmgmt_js_delay:0,postreveallogin_sleep:0,postacctmgmt_sleep:0,postrevealcpw_sleep:0,posttrigger_sleep:0,postlogout_sleep:0,start_delay:0,post_login_submit_delay:1100,post_js_begin_delay:5555,js_finish_delay:2E3,session_timeout:DEFAULT_SESSION_TIMEOUT,document_complete_timeout:0,
proceed_on_interactive:0,click_on_fields_on_fill:0,fill_password_fields_via_keys:0},r_tesco={},r_netflix={},minimal_recipe={symbolic:"",login_url:"",field_info:[],generate_pref_overrides:{minlength:6}},telegraph={symbolic:"Daily Telegraph"},amex={symbolic:"American Express",field_info:[],jsfrag:[]},boa={symbolic:"Bank of America",login_url:"https://www.bankofamerica.com/sitemap/hub/signin.go",field_info:[{id_type:"TYPE_ID",id_value:"userId",id_function:"FN_LOGIN"},{id_type:"TYPE_ID",id_value:"password",
id_function:"FN_PASSWORD"}],jsfrag:[]},capitalone={generate_pref_overrides:{mindigits:2,digits:1,special:0}},capitalone360={},testrig={symbolic:"Test",login_url:"http://www.netrot.net/~chang/form/formtest1.html",field_info:[{id_type:"TYPE_ID",id_value:"email",id_function:"FN_LOGIN"},{id_type:"TYPE_NAME",id_value:"password",id_function:"FN_PASSWORD"},{id_type:"TYPE_XPATH",id_value:"//input[@type='submit']",id_function:"FN_LOGIN_SUBMIT"},{id_type:"TYPE_ID",id_value:"email",id_function:"FN_IS_LOGGED_IN_NEGATION"},
{id_type:"TYPE_XPATH",id_value:"//input[@type='submit']",id_function:"FN_CPW_SUBMIT"}],jsfrag:[],generate_pref_overrides:{mindigits:1,digits:1,special:0,minlength:6}};
function CPWbot_bg_lib(){function g(a){m_last_overlay_msg=a}function e(){m_last_overlay_msg=""}function J(a){return!a?null:a.logout_url}function M(a){return G(a,FN_PASSWORD)}function s(a){return G(a,FN_LOGIN)}function G(a,b){if(!a||!a.field_info)return null;var c,d=null,f=null;for(c=0;c<a.field_info.length;c++)if(d=a.field_info[c],d.id_function==b){f={id_type:d.id_type,id_value:d.id_value};break}return f}function Pa(a){return u(a,JS_PRE_NAVIGATE_CPW)}function kb(a){return u(a,JS_POST_NAVIGATE_CPW)}
function Jb(a){return u(a,JS_PRE_ACCTMGMT)}function lb(a){return u(a,JS_POST_ACCTMGMT)}function Kb(a){return u(a,JS_PRE_CPW)}function Lb(a){return u(a,JS_POST_CPW)}function Hc(a){return u(a,JS_PRE_LOGIN)}function Ic(a){return u(a,JS_POST_LOGIN)}function mb(a){return u(a,JS_LOGIN_REVEAL)}function Jc(a){return u(a,JS_LOGIN_SUBMIT)}function Kc(a){return u(a,JS_LOGIN_ENTRY_SUBMIT)}function Mb(a){return u(a,JS_VALIDATE_LOGIN_SUCCESS)}function Nb(a){return u(a,JS_VALIDATE_CPW_SUCCESS)}function Ob(a){return u(a,
JS_FINISH)}function Lc(a){return u(a,JS_VALIDATE_CHALLENGE_SUCCESS)}function Pb(a){return u(a,JS_BEGIN)}function Mc(a){return u(a,JS_PRE_LOGOUT)}function Qb(a){return u(a,JS_POST_LOGOUT)}function Nc(a){return u(a,JS_PRE_LOGIN_ENTRY)}function Oc(a){return u(a,JS_POST_LOGIN_ENTRY)}function Pc(a){return u(a,JS_VALIDATE_LOGIN_ENTRY_SUCCESS)}function Qc(a){return u(a,JS_PRE_DOCAPTCHA)}function Rc(a){return u(a,JS_POST_DOCAPTCHA)}function Rb(a){var b=null;a&&"undefined"!=typeof a.cpw_change_success_url&&
(b=a.cpw_change_success_url);return b}function Sb(a){var b=null;a&&"undefined"!=typeof a.cpw_change_failure_url&&(b=a.cpw_change_failure_url);return b}function Tb(a){var b=null;a&&"undefined"!=typeof a.login_failure_url&&(b=a.login_failure_url);return b}function Ub(a){var b=null;a&&"undefined"!=typeof a.login_success_url&&(b=a.login_success_url);return b}function Sc(a){var b=null;a&&"undefined"!=typeof a.login_entry_failure_url&&(b=a.login_entry_failure_url);return b}function Tc(a){var b=null;a&&
"undefined"!=typeof a.login_entry_success_url&&(b=a.login_entry_success_url);return b}function Uc(a){var b=null;a&&"undefined"!=typeof a.challenge_invalidate_url&&(b=a.challenge_invalidate_url);return b}function Vc(a){var b=null;a&&"undefined"!=typeof a.challenge_validate_url&&(b=a.challenge_validate_url);return b}function u(a,b){if(!a||!a.jsfrags)return null;var c,d,f;for(c=0;c<a.jsfrags.length;c++)if(d=a.jsfrags[c],d.jstype==b){f=d.jsfrag;break}return f}function B(a,b,c){if(!b||!c)return null;if(b=
c(b)){c=(new Date).getTime();null===c&&(c=0);var d=("function"==typeof lp_sha256?lp_sha256:SHA256)(a.toString()+b+c.toString());c=("function"==typeof fasthash?fasthash:"function"==typeof crc32?crc32:"function(j) { if (j) { return j.length; } return 0; }")(b);verbose_log("injecting javascript fragment into CS: "+b);n(N,"Injected Javascript into Document");sendCS(a,{cmd:"run_cpwbot_js",req_id:d,js:b,hash:c},"all");return!0}return!1}function ua(a){return"undefined"!=typeof g_sites?g_sites[a]:"undefined"!=
typeof lpaccts?lpaccts[a]:null}function Vb(a,b,c,d,f,j){if(!c)return!1;null===d&&(d=0);null===j&&(j=0);if("undefined"==typeof f||null===f)f=DEFAULT_FILL_DELAY;n(N,"Filling Field");var e=(new Date).getTime();null===e&&(e=0);e=("function"==typeof lp_sha256?lp_sha256:SHA256)(a.toString()+c.id_value+e.toString());sendCS(a,{cmd:"cpwbot_fill_field",req_id:e,id_type:c.id_type,id_value:c.id_value,field_value:b,type:"text",formname:"",should_click:d,should_fill_via_keys:j,delay:f},"all");return!0}function ma(a,
b,c,d,f,j){if(!c)return!1;null===d&&(d=0);null===j&&(j=0);if("undefined"==typeof f||null===f)f=DEFAULT_FILL_DELAY;n(N,"Filling Password Field");var e=(new Date).getTime();null===e&&(e=0);e=("function"==typeof lp_sha256?lp_sha256:SHA256)(a.toString()+c.id_value+e.toString());sendCS(a,{cmd:"cpwbot_fill_field",req_id:e,id_type:c.id_type,id_value:c.id_value,field_value:b,type:"password",formname:"",should_click:d,should_fill_via_keys:j,delay:f},"all");return!0}function na(a,b,c){if(!b)return!1;if("undefined"==
typeof c||null===c)c=DEFAULT_CLICK_DELAY;Wb=(new Date).getTime()+CLICK_RETRY_TIME+c;nb=!1;n(N,"Clicking");var d=(new Date).getTime();null===d&&(d=0);d=("function"==typeof lp_sha256?lp_sha256:SHA256)(a.toString()+b.id_value+d.toString());verbose_log("click_field id="+d+" saved to m_pwchange_last_click_field_id");aa=d;Qa=0;b={cmd:"cpwbot_click_field",msgid:d,pwchangestate:h,id_type:b.id_type,id_value:b.id_value,delay:c};sendCS(a,b,"all");m_lastclick_metadata=b;return!0}function Ra(a,b,c){if(!b||!c)return!1;
var d="",d="",f=ua(c.aid);if(!f)return Aa("given invalid aid - data consistency error?"),!1;CPWbot_bg.do_milestone(a,Xb,b);L("pre-login-form-js");B(a,b,Hc);var j=s(b);c=M(b);var e=Sa(b),g=Ta(b),h=rnd2=0;ob&&(h=Y(),rnd2=Y());var t=0;j&&(t++,d=getusernamefromacct(f),Vb(a,d,j,e,0*t+h,!1));c&&(t++,d=getpasswordfromacct(f),ma(a,d,c,e,0*t+h+rnd2,g));L("post-login-form-js");B(a,b,Ic);return!0}function pb(a,b){if(!b)return!1;CPWbot_bg.do_milestone(a,Yb,b);var c=!1;oa=!1;var d=G(b,FN_LOGIN_SUBMIT);d&&(c=DEFAULT_CLICK_DELAY,
"undefined"!=typeof b.login_delay&&(c=b.login_delay),oa=!0,na(a,d,c),c=!0);B(a,b,Jc)&&(c=!0);return c?null:!0}function Zb(a,b,c){if(!b||!c)return!1;var d="",d="",f=ua(c.aid);if(!f)return Aa("given invalid aid - data consistency error?"),!1;CPWbot_bg.do_milestone(a,$b,b);B(a,b,Nc);var j=G(b,FN_LOGIN_ENTRY_USERNAME);c=G(b,FN_LOGIN_ENTRY_PASSWORD);var e=Sa(b),g=Ta(b),h=rnd2=0;ob&&(h=Y(),rnd2=Y());var t=0;j&&(t++,d=getusernamefromacct(f),Vb(a,d,j,e,0*t+h,!1));c&&(t++,d=getpasswordfromacct(f),ma(a,d,c,
e,0*t+h+rnd2,g));B(a,b,Oc);return!0}function ac(a,b){if(!b)return!1;CPWbot_bg.do_milestone(a,bc,b);var c=!1;pa=!1;var d=G(b,FN_LOGIN_ENTRY_SUBMIT);d&&(c=DEFAULT_CLICK_DELAY,"undefined"!=typeof b.login_delay&&(c=b.login_delay),pa=!0,na(a,d,c),CPWbot_bg.mark_timestamp("wait_for_click_ack_M"),c=!0);B(a,b,Kc)&&(c=!0);return c?null:!0}function D(a){verbose_log("entered cpwbot_cs_finish to clean up "+a);if(null!==x)if(x!=a)null!==x&&verbose_log("stale call: started up a new password change on different tab - ABORT - tabid=="+
a+" g_pwchangetabid="+x);else{var b={aid:qa,recipe:C,desc:"cpwbot_finish"};g_v2engine?CPWbot_bg.wait_for_doc_complete(a,null,function(a){verbose_log("cpwbot_finish callback!  on tabid="+a);sendCS(a,{cmd:"cpwbot_finish"},"all")},b):sendCS(a,{cmd:"cpwbot_finish"})}}function Wc(a){var b=[],c=[FN_CPW_OTHER,FN_CURRENT_PASS,FN_NEW_PASS,FN_NEW_PASS_CONFIRM],d;for(d=0;d<c.length;d++){var f=E(a,c[d]);f&&0<f.length&&(b=b.concat(f))}return b}function Xc(a){var b=[],c=[FN_CPW_INVALID],d,f;for(d=0;d<c.length;d++){var j=
E(a,c[d]);if(j&&0<j.length)for(f=0;f<j.length;f++){var e=j[f];e&&b.push(e)}}return b}function Yc(a){var b=[],c=[FN_PASSWORD,FN_LOGIN_OTHER],d;for(d=0;d<c.length;d++){var f=E(a,c[d]);f&&0<f.length&&(b=b.concat(f))}return b}function Zc(a){var b=[],c=[FN_LOGIN_INVALID],d;for(d=0;d<c.length;d++){var f=E(a,c[d]);f&&0<f.length&&(b=b.concat(f))}return b}function $c(a){var b=[],c=[FN_LOGIN_ENTRY_USERNAME],d;for(d=0;d<c.length;d++){var f=E(a,c[d]);f&&0<f.length&&(b=b.concat(f))}return b}function ad(a){var b=
[],c=[FN_LOGIN_ENTRY_INVALID],d;for(d=0;d<c.length;d++){var f=E(a,c[d]);f&&0<f.length&&(b=b.concat(f))}return b}function bd(a){var b=[],c=[FN_LOGIN_SUCCESS],d;for(d=0;d<c.length;d++){var f=E(a,c[d]);f&&0<f.length&&(b=b.concat(f))}return b}function cd(a){var b=[],c=[FN_LOGIN_SUCCESS_INVALID],d;for(d=0;d<c.length;d++){var f=E(a,c[d]);f&&0<f.length&&(b=b.concat(f))}return b}function dd(a){var b=[],c=[FN_LOGIN_ENTRY_SUCCESS],d;for(d=0;d<c.length;d++){var f=E(a,c[d]);f&&0<f.length&&(b=b.concat(f))}return b}
function ed(a){var b=[],c=[FN_LOGIN_ENTRY_SUCCESS_INVALID],d;for(d=0;d<c.length;d++){var f=E(a,c[d]);f&&0<f.length&&(b=b.concat(f))}return b}function fd(a){var b=[],c=[FN_CPW_SUCCESS],d;for(d=0;d<c.length;d++){var f=E(a,c[d]);f&&0<f.length&&(b=b.concat(f))}return b}function gd(a){var b=[],c=[FN_CPW_SUCCESS_INVALID],d;for(d=0;d<c.length;d++){var f=E(a,c[d]);f&&0<f.length&&(b=b.concat(f))}return b}function hd(a){var b=[],c=[FN_IS_LOGGED_IN],d;for(d=0;d<c.length;d++){var f=E(a,c[d]);f&&0<f.length&&(b=
b.concat(f))}return b}function id(a){var b=[],c=[FN_IS_LOGGED_IN_NEGATION],d;for(d=0;d<c.length;d++){var f=E(a,c[d]);f&&0<f.length&&(b=b.concat(f))}return b}function jd(a){var b=[],c=[FN_CHALLENGE_PASSWORD,FN_CHALLENGE_OTHER],d;for(d=0;d<c.length;d++){var f=E(a,c[d]);f&&0<f.length&&(b=b.concat(f))}return b}function kd(a){var b=[],c=[FN_CHALLENGE_INVALID],d;for(d=0;d<c.length;d++){var f=E(a,c[d]);f&&0<f.length&&(b=b.concat(f))}return b}function ld(){return G(recipe_obj,FN_CHALLENGE_SUCCESS)}function md(){return G(recipe_obj,
FN_CHALLENGE_SUCCESS_INVALID)}function cc(a){var b=[],c=[FN_CAPTCHA_SUCCESS,FN_PASSWORD_HINT_SUCCESS,FN_MULTI_FACTOR_SUCCESS],d;for(d=0;d<c.length;d++){var f=E(a,c[d]);f&&0<f.length&&(b=b.concat(f))}return b}function E(a,b){var c=[];if(!a||!a.field_info)return c;var d,f;for(d=0;d<a.field_info.length;d++)f=a.field_info[d],f.id_function==b&&(f={id_type:f.id_type,id_value:f.id_value},c.push(f));return c}function Ua(a){var b=DEFAULT_VALIDATE_TIMEOUT;if(!a)return b;"undefined"!=typeof a.validate_timeout&&
(a=parseInt(a.validate_timeout))&&!isNaN(a)&&(b=a);return b}function ba(a,b,c){null===c&&(c=1);if(null===a||!b)return!1;var d=b.desc;c=b.recipe;var f=b.fn_url_failed,j=b.fn_url_success,e=b.fn_required,g=b.fn_rejected;q=!0;qb=(new Date).getTime();Ba=ia=!1;console_log("cpwbot check_tab_for_state for "+d);b=e?e(c):[];var e=g?g(c):[],h=CPWbot_bg.JSON.stringify(b),t=CPWbot_bg.JSON.stringify(e),g=[],k=[FN_CAPTCHA,FN_PASSWORD_HINT,FN_MULTI_FACTOR],n;for(n=0;n<k.length;n++){var s=E(c,k[n]);s&&0<s.length&&
(g=g.concat(s))}g=CPWbot_bg.JSON.stringify(g);rb=dc(a);if(0==b.length&&0==e.length&&!j&&!f)return L("WARN: "+d+" has no field or url criteria defined to validate against"),!0;b=Ua(c);j=j?j(c):null;f=f?f(c):null;e=(new Date).getTime();null===e&&(e=0);var A=("function"==typeof lp_sha256?lp_sha256:SHA256)(a.toString()+d+e.toString());R=A;ec=h;fc=t;verbose_log("interrogate id="+R+" desc="+d);H=[];c={cmd:"cpwbot_validate_state",desc:d,required_fields:h,rejected_fields:t,id:R,validate_timeout:b,timestamp:e,
proceed_on_interactive:gc(c)?1:0,interactive_fields:g};j&&(c.required_url=j);f&&(c.rejected_url=f);Z=c;S=d;sendCS(a,c,"all");verbose_log("setup setimeout for "+b/1E3+" seconds finish_cpwbot_validate_state");setTimeout(function(){CPWbot_bg&&CPWbot_bg.finish_cpwbot_validate_state(a,A,h,t,d)},b);return null}function T(){return null}function Va(a,b,c,d){if(d||!CPWbot_bg.get_docaptchastate())b?m_last_overlay_msg=b:b=m_last_overlay_msg,c||(c=C),b={msg:b,symbolic:U(c)},b=CPWbot_bg.JSON.stringify(b),sendCS(a,
{cmd:"do_cpwbot_overlay",msg:b},g_CS_tops[a])}function hc(a){sendCS(a,{cmd:"hide_cpwbot_overlay"},"all");return!0}function ic(a){var b=null;if(!a)return b;"undefined"!=typeof a.generate_pref_overrides&&(b=a.generate_pref_overrides);return b}function jc(a){var b=0;if(!a)return null;"undefined"!=typeof a.postacctmgmt_sleep&&(b=a.postacctmgmt_sleep);return b}function kc(a){var b=0;if(!a)return null;"undefined"!=typeof a.postrevealcpw_sleep&&(b=a.postrevealcpw_sleep);return b}function sb(a){var b=0;if(!a)return null;
"undefined"!=typeof a.postreveallogin_sleep&&(b=a.postreveallogin_sleep);return b}function lc(a){var b=0;if(!a)return null;"undefined"!=typeof a.postlogout_sleep&&(b=a.postlogout_sleep);return b}function gc(a){var b=!1;if(!a)return null;"undefined"!=typeof a.proceed_on_interactive&&(b=a.proceed_on_interactive?!0:!1,"0"===a.proceed_on_interactive&&(b=!1));return b}function tb(a){var b=0;if(!a)return null;"undefined"!=typeof a.post_login_submit_delay&&(b=a.post_login_submit_delay);return b}function ub(a){var b=
0;if(!a)return null;"undefined"!=typeof a.session_timeout&&"number"==typeof a.session_timeout&&(b=a.session_timeout);return b}function Sa(a){var b=0;if(!a)return null;"undefined"!=typeof a.click_on_fields_on_fill&&(b=a.click_on_fields_on_fill?1:0);return b}function Ta(a){var b=0;if(!a)return null;"undefined"!=typeof a.fill_password_fields_via_keys&&(b=a.fill_password_fields_via_keys?1:0);return b}function mc(a){if(!a)return null;var b=DEFAULT_FILL_DELAY;"number"==typeof a.fill_field_delay&&(b=a.fill_field_delay);
verbose_log("fill field delay : "+b);return b}function nc(a){var b=!1;if(!a)return null;"undefined"!=typeof a.document_complete_timeout&&(b=a.document_complete_timeout);return b}function n(a,b){var c=["DEBUG","INFO","WARN","ERR"];if(a<N||a>Wa)a=N;return g_isfirefox&&lpisadmin||g_isdebug||g_isadmin?(c="["+c[a]+"] "+b+"\n",Xa+=c,verbose_log(c),!0):!1}function oc(a,b){var c=!1;if(!b||!a)return debug&&L("validate_xpath: none"),c;try{var d=g_isfirefox?new a.defaultView.XPathEvaluator:new XPathEvaluator;
if(!d&&debug)return L("NO XPATH EVALUATOR AVAILABLE ????"),!0;d.evaluate(b,a.documentElement,null,g_isfirefox?a.defaultView.XPathResult.FIRST_ORDERED_NODE_TYPE:XPathResult.FIRST_ORDERED_NODE_TYPE,null);c=!0}catch(f){console_error("error validating '"+b+"', exception: "+f),c=!1}return c}function pc(a){var b=g_isfirefox?LP.getBrowser().selectedTab.linkedBrowser.contentDocument:document;if(!b||!a)return L("Bad Recipe: none"),!1;var c,d;if(!(!a?0:a.login_url))return L("Bad Recipe: no login url"),!1;if(!U(a))return L("Bad Recipe: no symbolic"),
!1;if(!a.field_info||0>=a.field_info.length)return L("Bad Recipe: no fields"),!1;if(!qc(a))return!1;var f=!1,j=!1,e=!1,g=!1,h=!1,t=!1,k=!1,n=!1,s=!1;for(c=0;c<a.field_info.length;c++)switch(d=a.field_info[c],d.id_function){case FN_LOGIN:case FN_LOGIN_SUBMIT:case FN_PASSWORD:f=!0;break;case FN_CURRENT_PASS:case FN_NEW_PASS:case FN_NEW_PASS_CONFIRM:case FN_CPW_SUBMIT:h=!0;break;case FN_CPW_SUCCESS:case FN_CPW_SUCCESS_INVALID:t=!0;break;case FN_LOGIN_SUCCESS:case FN_LOGIN_SUCCESS_INVALID:e=!0;break;
case FN_IS_LOGGED_IN:case FN_IS_LOGGED_IN_NEGATION:j=!0;break;case FN_NAVIGATE_TO_LOGOUT:n=!0}if(Rb(a)||Sb(a)||Nb(a))k=!0;if(Ub(a)||Tb(a)||Mb(a))g=!0;J(a)&&(s=!0);if(!f||!j||!e&&!g||!h||!n&&!s||!t&&!k)return L("Bad Recipe for "+U(a)+": has_login_fields?"+f+" has_logged_in_fields?"+j+" has_login_success_fields?"+e+" has_login_success_alt?"+g+" has_logout_field?"+n+" has_logout_alt?"+s+" has_cpw_fields?"+h+" has_cpw_success_fields?"+t+" has_cpw_success_alt?"+k),!1;for(c=0;c<a.field_info.length;c++)if(d=
a.field_info[c],d.id_type==TYPE_XPATH){if(!oc(b,d.id_value))return L("Bad Recipe: bad xpath"),!1;if(d.id_value&&0<d.id_value.indexOf("@clas,"))return L("Bad Recipe: @clas mispell"),!1}else if(d.id_type==TYPE_ID||d.id_type==TYPE_NAME)if(d.id_value&&(0<=d.id_value.indexOf("//")||0<=d.id_value.indexOf("text()")||0<=d.id_value.indexOf("contents(")))return L("Bad Recipe: xpath in non-xpath field def"),!1;return!0}function qc(a){var b,c,d,f=!0,j={id_function:1,id_value:1,id_type:1};if(!a.field_info||0>=
a.field_info.length)return!1;for(c=0;c<a.field_info.length;c++){if((b=a.field_info[c])&&"number"!=typeof b.id_function)verbose_log(sprintf("field %s has invalid function '%s'",b.id_value,b.id_function)),f=!1;for(d in b)b.hasOwnProperty(d)&&!j[d]&&(verbose_log(sprintf("found invalid field property '%s'",d)),f=!1)}j={jsfrag:1,jstype:1};if(a.jsfrags&&0<a.jsfrags.length)for(c=0;c<a.jsfrags.length;c++){if((b=a.jsfrags[c])&&"number"!=typeof b.jstype)verbose_log(sprintf("js with invalid type '%s'",b.jstype)),
f=!1;for(d in b)b.hasOwnProperty(d)&&!j[d]&&(verbose_log(sprintf("found invalid javascript property '%s'",d)),f=!1)}j={length:1,maxlength:1,minlength:1,special:1,digits:1,upper:1,lower:1,mindigits:1};if(a.generate_pref_overrides)for(d in a.generate_pref_overrides)a.generate_pref_overrides.hasOwnProperty(d)&&!j[d]&&(verbose_log(sprintf("found invalid generate preference '%s'",d)),f=!1);return f}function rc(){ja=ra=pa=ka=oa=da=ca=ea=!1}function sc(a,b){var c=b.docnum,d=b.url;if(null===p)return!1;(null===
p[c]||"undefined"==typeof p[c])&&CPWbot_bg.clear_frame_score(a,c,d);p[c]+=2;return!0}function dc(a){if(null===p||null===a)return 0;var b,c=0,d;for(d in CS_table)CS_table.hasOwnProperty(d)&&(b=CS_table[d],b.tabid===a&&(b=b.docnum,(CPWbot_bg.skip_frame_by_score(b)||skip_CS_by_score(a,b))&&c++));return c}function tc(a,b){null!==a&&null!==g_CS_tops[a]&&sendCS(a,{cmd:"do_result_div",msg:b},g_CS_tops[a])}function uc(a,b){var c=ub(b);c||(c=DEFAULT_SESSION_TIMEOUT);null!==V&&(0<V&&!isNaN(V))&&(c*=V);var d=
CPWbot_bg.get_session();CPWbot_bg.session_timeout_st_id=setTimeout(function(){if(d!=CPWbot_bg.get_session())verbose_log("stale timeout");else{CPWbot_bg.mark_timestamp("session_timeout");var b=CPWbot_bg.get_timestamp("session_timeout")-CPWbot_bg.get_timestamp("initial_cycle");verbose_log(sprintf("session timeout at %6.2f seconds after T=0",b/1E3));verbose_log("SESSION TIMEOUT WAKEUP");!Ca&&!Da&&x==a?(vc("timeout: a change is still running ? tabid="+a+"last state ="+h),CPWbot_bg.panic("session timeout")):
(D(a),CPWbot_bg.cpwbot_cs_finish_complete(a))}},c)}function wc(a,b,c){verbose_log("B1: validate_login_form ");h="B1";var d=null,d=CPWbot_bg.validate_login_form(a,b,{aid:c.aid,recipe:b});if(null===d)return verbose_log("B1: validate_login_form / CS callout "),v=!0,L("VALIDATE_IN_DOCWAIT=true"),null;if(d)do_A4(a,b,c);else return CPWbot_bg.do_milestone(a,va,b,""),D(a),!1;return!0}function wa(a,b,c){setTimeout(function(){CPWbot_bg.engine(a,b,c)},250)}function xc(a,b){var c=m_lastclick_metadata;Qa>nd&&
verbose_log("too many click retries");c&&(n(K,"Retry Click"),verbose_log("tabid="+a+" id_type="+c.id_type+" id_value="+c.id_value),sendCS(a,c,b),Qa++)}function fa(a){return(new Date).getTime()>Wb&&!nb?(nb=!0,xc(a,"all"),!0):!1}function yc(a,b){L(sprintf("[%s] time factor adjustment=%6.2f",U(a),b));return!0}function zc(){}function Ac(a,b){CPWbot_bg.do_milestone(a,vb,b);D(a);CPWbot_bg.cpwbot_cs_finish_complete(a);return!0}function vc(a){CPWbot_bg&&(n(Wa,a),CPWbot_bg.phone_home(null,null,{severity:"fatal",
msg:a}))}function Aa(a){n(od,a);return CPWbot_bg.phone_home(null,null,{severity:"warning",msg:a})}function xa(a,b){var c;c=0<cc(b).length?!0:!1;c?CPWbot_bg.do_milestone(a,wb,b):(CPWbot_bg.do_milestone(a,xb,b),D(a))}function U(a){return a?a.symbolic:""}function Y(a){a||(a=100);return"undefined"==typeof Math?0:Math.floor(Math.random(a)+10)}var Bc=this,Cc=0,h=null,x=null,ga=null,C=null,qa=0,Z=null,R=null,S=null,yb=null,aa=null;e();var rb=null,H=[],Ya=!1,Za=!1,$a=!1,ab=!1,F=!1,Xa="",Ca=!1,Da=!1,ea=!1,
oa=!1,da=!1,ca=!1,ra=!1,ja=!1,ka=!1,pa=!1,p={},ia=!1,Ba=!1,zb=!1,Ab=!1,bb=!1,cb=!1,db=!1,sa=!1,eb=!1,fb=!1,ob=!1,gb=3,Bb=4,Cb=5,Db=6,Eb=7,wb=9,Xb=68,Yb=69,Dc=70,Ec=71,bc=74,$b=75,Ea=129,va=130,Fb=131,Gb=132,hb=134,Hb=137,vb=138,xb=139,Fa=141,k=[""];k[1]=gs("LastPass is loading...");k[2]=gs("LastPass is loading website...");k[gb]=gs("LastPass is logging in...");k[Bb]=gs("LastPass is changing your password now...");k[Cb]=gs("LastPass is changing your password now...");k[Db]=gs("LastPass is changing your password now...");
k[Eb]=gs("LastPass is changing your password now...");k[8]=gs("LastPass is logging in...");k[wb]=gs("The website needs you to enter information. Please switch to the tab and enter it.");k[63]=gs("Congratulations! Your password for %s was updated, and is now saved in your LastPass vault. Your change will sync on every device.");k[128]=gs("We're sorry. We were not able to change your password automatically for %s. Your password was not changed.");k[248]=k[128]+" "+gs("The random password that was generated has been saved to your vault.");
k[136]=k[128];k[133]=gs("Timed out waiting for the page to load.  Retry?");k[va]=k[128];k[Ea]=k[128];k[hb]=k[128];k[135]=k[128];k[Fb]=k[128];k[Gb]=k[128];k[Hb]=k[128];k[vb]=gs("Halt Requested");k[xb]=gs("Unable to proceed, the website does not allow automated password change.");k[140]=gs("Timed out");k[Fa]=k[128];"function"==typeof alertfrombg&&(this.alert=alertfrombg);g_isfirefox&&(this.alert=alert);this.JSON=JSON;JSON||(this.JSON=LPJSON);this.get_pwchangestate=function(){return h};this.get_pwchangetabid=
function(){return x};this.get_login_url=function(a){return!a?null:a.login_url};this.get_cpw_url=function(a){return!a?null:a.cpw_url};this.get_acctmgmt_url=function(a){return!a?null:a.acctmgmt_url};this.conditional_js_exec=function(a,b,c){return B(a,b,c)};this.show_cpwbot_overlay=function(a,b,c){return Va(a,b,c)};this.in_validate=function(){return Z&&R&&null!=S&&""!=S&&"undefined"!=typeof S};this.in_validate_outer=function(){return Bc.in_validate()||q||v};this.get_last_overlay_message=function(){return m_last_overlay_msg};
this.reveal_cpw=function(a,b){if(!b)return!1;var c=b.recipe,d=b.payload,f=d.aid;if(!c||!d)return!1;L("reveal_cpw called after wait-for-document-complete tabid="+a);CPWbot_bg.mark_timestamp("reveal_cpw");n(K,"Reveal Change-Password Form");h="D";Za=!1;B(a,c,Pa);var j=!c?null:c.cpw_url;if(j)return L("call cpw:loadurl with "+j),f=null,g_CS_tops&&(f=g_CS_tops[a],g_ischrome&&0!=f&&L("loadurl is not sending to docnum==0 ! "+f)),sendCS(a,{cmd:"loadurl",url:j},f),O=!0,verbose_log("m_in_loadurl set"),C=c,ga=
d,Za=!0,null;ca=!1;if(d=G(c,FN_NAVIGATE_TO_CPW))verbose_log("click on FN_NAVIGATE_TO_CPW field!"),j=DEFAULT_CLICK_DELAY,"undefined"!=typeof c.cpw_delay&&(j=c.cpw_delay),ca=!0,L("now waiting for click_ack_D"),na(a,d,j),CPWbot_bg.mark_timestamp("wait_for_click_ack_D");d=!1;c?"undefined"!=typeof c.reveal_cpw_js_delay&&(d=c.reveal_cpw_js_delay?!0:!1,"0"===c.reveal_cpw_js_delay&&(d=!1)):d=null;if(d&&(Za=!0,kc(c)))return null;B(a,c,kb);if(b.didcallout)return L("end of reveal_cpw thread with callout to CS - hack Dpickup to resume for aid="+
f),h="Dpickup",null;L("no callout to CS, so reveal_cpw does not end thread, returning to initiate");return!0};this.navigate_to_acctmgmt=function(a,b){if(!b)return!1;var c=b.recipe,d=b.payload,f=d.aid;L("navigate_to_acctmgmt called after wait-for-document-complete tabid="+a);CPWbot_bg.mark_timestamp("acctmgmt_nav");h="C";if(!c)return!1;n(K,"Navigate to Account Management Page");$a=!1;B(a,c,Jb);var j=!c?null:c.acctmgmt_url;if(j)return L("call acctmgmt:loadurl with "+j),f=null,g_CS_tops&&(f=g_CS_tops[a]),
sendCS(a,{cmd:"loadurl",url:j},f),O=!0,verbose_log("m_in_loadurl set"),C=c,ga=d,$a=!0,null;da=!1;if(d=G(c,FN_NAVIGATE_TO_ACCTMGMT))verbose_log("click on FN_NAVIGATE_TO_ACCTMGMT field!"),j=DEFAULT_CLICK_DELAY,"undefined"!=typeof c.acctmgmt_delay&&(j=c.acctmgmt_delay),da=!0,L("now waiting for click_ack C"),na(a,d,j),CPWbot_bg.mark_timestamp("wait_for_click_ack_C");d=!1;c?"undefined"!=typeof c.navigate_acctmgmt_js_delay&&(d=c.navigate_acctmgmt_js_delay?!0:!1,"0"===c.navigate_acctmgmt_js_delay&&(d=!1)):
d=null;if(d&&($a=!0,jc(c)))return null;B(a,c,lb);if(b.didcallout)return L("end of navigate_to_acctmgmt thread with callout to CS - hack Cpickup to resume for aid="+f),h="Cpickup",null;g_v2engine||L("no callout to CS, so nav_to_acctmgmt does not end thread, returning to initiate");return!0};this.trigger_cpw=function(a,b){if(fb)return!1;fb=!0;verbose_log("trigger_cpw entered");CPWbot_bg.mark_timestamp("trigger_cpw");if(!b)return!1;var c=b.recipe,d=b.payload;if(!c||!d)return!1;var f=Sa(c),j=Ta(c);L("trigger_cpw called after wait-for-document-complete tabid="+
a);h="E";var e=d.aid,g=ua(e),k="";if(g)k=g.url;else return Aa("given invalid aid - data consistency error?"),!1;B(a,c,Kb);var t=G(c,FN_CURRENT_PASS),s=G(c,FN_NEW_PASS),q=G(c,FN_NEW_PASS_CONFIRM),y=G(c,FN_CPW_SUBMIT),A=15,p=1,v=1,w=1,u=0,x=1,D=0,E=1,F=null;g_isfirefox?(LP.lpprefsHasUserValue("genpw_passlen")&&(A=LP.lpprefsGetIntPref("genpw_passlen")),LP.lpprefsHasUserValue("genpw_upper")&&(p=LP.lpprefsGetBoolPref("genpw_upper")?1:0),LP.lpprefsHasUserValue("genpw_lower")&&(v=LP.lpprefsGetBoolPref("genpw_lower")?
1:0),LP.lpprefsHasUserValue("genpw_digits")&&(w=LP.lpprefsGetBoolPref("genpw_digits")?1:0),LP.lpprefsHasUserValue("genpw_special")&&(u=LP.lpprefsGetBoolPref("genpw_special")?1:0),LP.lpprefsHasUserValue("genpw_mindigits")&&(x=LP.lpprefsGetIntPref("genpw_mindigits")?1:0),LP.lpprefsHasUserValue("genpw_ambig")&&(D=LP.lpprefsGetBoolPref("genpw_ambig")?1:0),LP.lpprefsHasUserValue("genpw_reqevery")&&(E=LP.lpprefsGetBoolPref("genpw_reqevery")?1:0),LP.lpprefsHasUserValue("genpw_pronounceable")&&(F=LP.lpprefsGetBoolPref("genpw_pronounceable")?
1:0)):(A=parseInt(lpGetPref("generate_length",A)),p=parseInt(lpGetPref("generate_upper",p)),v=parseInt(lpGetPref("generate_lower",v)),w=parseInt(lpGetPref("generate_digits",w)),u=parseInt(lpGetPref("generate_special",u)),x=parseInt(lpGetPref("generate_mindigits",x)),D=parseInt(lpGetPref("generate_ambig",D)),E=parseInt(lpGetPref("generate_reqevery",E)),F=parseInt(lpGetPref("generate_pronounceable",F)));0==p&&(0==v&&0==w&&0==u)&&(p=v=w=1);var C=getpasswordfromacct(g);C.length>A&&(A=C.length);var z=
ic(c);null!==z&&("undefined"!=typeof z.length&&null!==z.length&&(A=z.length),"undefined"!=typeof z.maxlength&&null!==z.maxlength&&A>z.maxlength&&(A=z.maxlength),"undefined"!=typeof z.minlength&&null!==z.minlength&&A<z.minlength&&(A=z.minlength),"undefined"!=typeof z.special&&null!==z.special&&(u=z.special?1:0),"undefined"!=typeof z.digits&&null!==z.digits&&(w=z.digits?1:0),"undefined"!=typeof z.upper&&null!==z.upper&&(p=z.upper?1:0),"undefined"!=typeof z.lower&&null!==z.lower&&(v=z.lower?1:0),"undefined"!=
typeof z.mindigits&&null!==z.mindigits&&(x=z.mindigits));n(K,"Generating a new password that is "+A+" chars long, "+(p?"with":"without")+" uppercase chars, "+(v?"with":"without")+" lowercase chars, "+(w?"with":"without")+" numeric chars, "+(u?"with":"without")+" special chars, with at least "+x+" numbers,");A=(g_isfirefox?LP.lpCreatePass:lpCreatePass)(A,p,v,w,u,x,D,E,F);L("generated new password: "+(g_show_pw_in_logs||g_isadmin?A:"REDACTED"));L("saving "+(g_show_pw_in_logs||g_isadmin?A:"REDACTED")+
" to "+k+" as generated password");g_isfirefox?ff_save_generated_password(A,k,!0,!0):savePassword(A,k,a,1);g_isfirefox?null!==LP.lpgenpwlist&&LP.lpgenpwlist.unshift(A):null!==g_genpws&&g_genpws.unshift(A);CPWbot_bg.do_milestone(a,73,c);d.newpw=lpenc_acct(A,g,"undefined"==typeof g_shares?lpshares:g_shares);d.curpw=lpenc_acct(C,g,"undefined"==typeof g_shares?lpshares:g_shares);ga=d;yb=d.newpw;n(K,"Filling Change-Password Form");d=mc(c);k=rnd2=rnd3=rnd4=0;ob&&(k=Y(),rnd2=Y(),rnd3=Y(),rnd4=Y());g=0;t&&
(g+=1,ma(a,C,t,f,d*g+k,j));s&&(g+=1,ma(a,A,s,f,d*g+k+rnd2,j));q&&(g+=1,ma(a,A,q,f,d*g+k+rnd2+rnd3,j));y&&(ea=!0,L("now waiting for click_ack E"),f=null,"undefined"!=typeof c.trigger_cpw_delay&&(f=c.trigger_cpw_delay),verbose_log("trigger cpw delay : "+f+" + "+d*g),j=f,j=null===f?d*g:f+d*g+rnd4,na(a,y,j),CPWbot_bg.mark_timestamp("wait_for_click_ack_E"));pass;B(a,c,Lb);if(b.didcallout)return L("end of trigger_cpw thread with callout to CS - hack Epickup to resume for aid="+e),h="Epickup",null;L("no callout to CS, so trigger_cpw does not end thread, returning to initiate");
return!0};this.navigate_to_login=function(a,b){if(!b)return!1;var c=b.recipe;h="B";Ya=!1;if(!c)return!1;n(K,"Navigate to Login");var d=!c?null:c.login_url;if(d){L("call login:loadurl with "+d);var f=null;g_CS_tops&&(f=g_CS_tops[a],g_ischrome&&0!=f&&L("loadurl is not sending to docnum==0 ! "+f));sendCS(a,{cmd:"loadurl",url:d},f);O=!0;verbose_log("m_in_loadurl set");C=c;ga=b;Ya=!0;return null}if(g_v2engine)return!1;d=!1;c?"undefined"!=typeof c.reveal_login_js_delay&&(d=c.reveal_login_js_delay?!0:!1):
d=null;if(d&&(Ya=!0,sb(c)))return null;B(a,c,mb);return!0};this.check_is_logged_in=function(a,b){if(!b)return!1;var c={recipe:b,desc:"validate_website_is_loggedin",fn_required:hd,fn_rejected:id,fn_url_success:T,fn_url_failed:T};if(CPWbot_bg.should_wait_for_document_complete(a,c))return q=!0,CPWbot_bg.wait_for_doc_complete(a,null,ba,c),null;L("validate_website_is_loggedin returns true, no wait ");return!0};this.validate_login_success=function(a,b){if(!b)return!1;B(a,b,Mb);var c={recipe:b,desc:"validate_login_success",
fn_required:bd,fn_rejected:cd,fn_url_success:Ub,fn_url_failed:Tb};if(CPWbot_bg.should_wait_for_document_complete(a,c))return q=!0,CPWbot_bg.wait_for_doc_complete(a,null,ba,c),null;L("validate_login_success returns true, no wait ");return!0};this.validate_login_entry_success=function(a,b){if(!b)return!1;B(a,b,Pc);var c={recipe:b,desc:"validate_login_entry_success",fn_required:dd,fn_rejected:ed,fn_url_success:Tc,fn_url_failed:Sc};if(CPWbot_bg.should_wait_for_document_complete(a,c))return q=!0,CPWbot_bg.wait_for_doc_complete(a,
null,ba,c),null;L("validate_login_entry_success returns true, no wait ");return!0};this.validate_cpw_success=function(a,b){if(!b)return!1;B(a,b,Nb);var c={recipe:b,desc:"validate_cpw_success",fn_required:fd,fn_rejected:gd,fn_url_success:Rb,fn_url_failed:Sb};if(CPWbot_bg.should_wait_for_document_complete(a,c))return q=!0,CPWbot_bg.wait_for_doc_complete(a,null,ba,c),null;L("validate_cpw_success returns true, no wait ");return!0};this.validate_login_form=function(a,b){if(!b)return!1;var c={recipe:b,
desc:"validate_login_form",fn_required:Yc,fn_rejected:Zc,fn_url_success:T,fn_url_failed:T};if(CPWbot_bg.should_wait_for_document_complete(a,c))return q=!0,CPWbot_bg.wait_for_doc_complete(a,null,ba,c),null;L("validate_login_form returns true, no wait ");return!0};this.validate_cpw_form=function(a,b){if(!b)return!1;var c={recipe:b,desc:"validate_cpw_form",fn_required:Wc,fn_rejected:Xc,fn_url_success:T,fn_url_failed:T};if(CPWbot_bg.should_wait_for_document_complete(a,c))return q=!0,CPWbot_bg.wait_for_doc_complete(a,
null,ba,c),null;L("validate_cpw_form returns true, no wait ");return!0};this.validate_login_entry_form=function(a,b){if(!b)return!1;var c={recipe:b,desc:"validate_login_entry_form",fn_required:$c,fn_rejected:ad,fn_url_success:T,fn_url_failed:T};if(CPWbot_bg.should_wait_for_document_complete(a,c))return q=!0,CPWbot_bg.wait_for_doc_complete(a,null,ba,c),null;L("validate_login_entry_form returns true, no wait ");return!0};this.revert_password=function(a,b){if(!b)return!1;alert("REVERT: TODO");return!0};
this.initiate=function(){};this.cpwbot_cs_finish_complete=function(a){verbose_log("cpwbot_cs_finish_complete on tabid="+a);x!=a?null!==x&&verbose_log("stale call: started up a new password change on different tab - ABORT - tabid=="+a+" g_pwchangetabid="+x):(null!==CPWbot_bg.session_timeout_st_id&&clearTimeout(CPWbot_bg.session_timeout_st_id),CPWbot_bg.session_timeout_st_id=null,null!==CPWbot_bg.docaptcha_si_id&&clearInterval(CPWbot_bg.docaptcha_si_id),CPWbot_bg.docaptcha_si_id=null,CPWbot_bg.mark_timestamp("finish_complete"),
CPWbot_bg.logout(),hc(a),CPWbot_bg.do_milestone(a,66,null))};this.finish_cpwbot_validate_state=function(a,b,c,d,f){verbose_log("ENTERED finish_cpwbot_validate_state");var j=!1,e=!1;if(x!=a)return verbose_log("finish_cpwbot_validate_state: !tabid, abort"),!1;if(b!=R)return verbose_log("finish_cpwbot_validate_state: ignoring stale request, current validate is "+S+"/"+R+", stale req is "+f+"/"+b+" "),!1;var g=Ua(C),k=R;if(ia&&!Ba)return ia=!1,Ba=!0,L("finish_cpwbot_validate_state: reload1 extending timeout for "+
f),setTimeout(function(){CPWbot_bg.finish_cpwbot_validate_state(a,k,c,d,f)},g),!1;verbose_log("finish_cpwbot_validate_state: closing out request "+f+"/"+b);if(null===H)return verbose_log("finish_cpwbot_validate_state: dup, abort"),!1;if(null===g_CS[a])return lploggedin?(L("finish_cpwbot_validate_state: reload2 extending timeout for "+f),setTimeout(function(){CPWbot_bg.finish_cpwbot_validate_state(a,k,c,d,f)},g)):(verbose_log("finish_cpwbot_validate_state: tab "+a+" closed "),CPWbot_bg.panic("logged out?")),
!1;g=rb;g_CS[a].length==H.length&&(e=!0);for(b=0;b<H.length;b++)if(H[b]){j=!0;break}e||verbose_log("finish_cpwbot_validate_state: sent out "+g_CS[a].length+" messages, received "+H.length+" messages, skipped "+g+" frames");b=e=0;for(var t in p)p.hasOwnProperty(t)&&!this.skip_frame_by_score(t)&&(e++,H[t]&&b++);b<e&&console_warn("CASE : still waiting to hear from important frames, expected to hear from "+e+", heard from "+b);j||(t=JSON.parse(c),e=JSON.parse(d),0==t.length&&0<e.length&&(j=!0));Z=H=null;
rb=0;g_v2engine?(v=q=!1,L("VALIDATE_IN_DOCWAIT=false"),P=j,y={},console_log("finish_cpwbot_validate_state complete result="+j+", wait for next engine cycle at "+h),pass):(j={aid:qa,recipe:C,validate_result:j},console_log("finish_cpwbot_validate_state resumed initiate with state="+h),CPWbot_bg.initiate(a,j,h));return!1};this.chk_cpw_resume=function(){return!1};this.cpwbot_validate_state_result_handler=function(a,b){var c=!1;if(CPWbot_bg&&null!==x&&a==x){var d=b.docnum;if("undefined"!=typeof d&&CPWbot_bg&&
null!==H){var f=JSON.parse(b.result);JSON.parse(b.rejected_fields);JSON.parse(b.required_fields);var j=!1,e=null;b.result_obj&&(e=JSON.parse(b.result_obj));var g=b.desc,k=b.id;L("received a "+g+" validate result from ["+a+"]["+d+"]["+b.url+"]["+b.docstate+"]["+b.state+"]="+f);if(S&&S!=g||R&&R!=k)L("unexpected validate msg - perhaps from the last validate call.... ignoring it"),L("got "+g+"/"+k+" expected "+S+"/"+R);else{k=!1;if(e){b.required_url&&n(N,"["+a+"]["+d+"] validate given success_url, result="+
e.url_success_match+" when matching success url = "+b.required_url);b.rejected_url&&n(N,"["+a+"]["+d+"] validate given bad_url, result="+e.url_failure_match+" when matching failure url = "+b.rejected_url);n(N,sprintf("[%s][%d] %s found %d/%d success fields, given %d invalid fields and %s invalid fields, %s captcha-ish fields",a,d,g,e.num_ok_matches,e.num_okfields,e.num_badfields,e.found_bad_match?"found":"did not find",e.found_interactive?"found":"did not find"));if(0<e.num_ok_matches)sc(a,b),e.found_interactive&&
(k=!0);else if(e.found_bad_match)sc(a,b),k=!0;else{var t=b.docnum,s=b.url;null!==p&&((null===p[t]||"undefined"==typeof p[t])&&CPWbot_bg.clear_frame_score(a,t,s),p[t]+=-2)}e.found_interactive&&(j=!0)}H[d]=f;d=dc(a);if(null===g_CS[a]&&CPWbot_bg&&Z)L("interrupted by a page load/refresh, reissuing validate for state "+h),H=[],sendCS(a,Z,"all");else if(g_CS[a]&&g_CS[a].length==H.length&&(c=!0),null===g_CS[a]?verbose_log("tab is reloading but cannot retry validate ? WTF"):verbose_log("["+a+"] "+g+" sent "+
g_CS[a].length+" messages, heard from "+H.length+", skipped "+d+" frames"),f||c||k||j)H=null,null===f&&(f=!1),Z=null,v=q=!1,L("VALIDATE_IN_DOCWAIT=false"),L("validate complete, result is "+f+" current state="+h),P=f,y=e}}else debug&&L("stale2? validate result tabid="+a+" g_pwchangetabid="+x+" g_pwchange_validate_desc="+S)}else debug&&L("stale1? validate result tabid="+a+" g_pwchangetabid="+x+" g_pwchange_validate_desc="+S)};this.cpwbot_finish_ack_handler=function(a,b){if(null!==a&&b){sendCS(a,{cmd:"cpwbot_finish_ack"},
"all");sendCS(a,{cmd:"hide_cpwbot_overlay"},"all");if(g_CS_tops[a]!=b.docnum)if(null==g_CS_tops[a]||"undefined"==typeof g_CS_tops[a])console_error("webpage has not finished loading");else{console_error("WTF : top "+g_CS_tops[a]+" but docnum is "+b.docnum);var c=getcsinfo(a,b.docnum),d=getcsinfo(a,g_CS_tops[a]);d&&verbose_log("["+g_CS_tops[a]+"] topdoc is "+d.url);c&&verbose_log("["+b.docnum+"] other doc is "+c.url);c&&c.parent_docnum==c.docnum?verbose_log("CS table says that "+b.docnum+" is top"):
d&&d.parent_docnum==d.docnum?verbose_log("CS table says that "+g_CS_tops[a]+" is top"):verbose_log("CS table mismatch, or reloading ? ")}CPWbot_bg.cpwbot_cs_finish_complete(a)}};this.cpwbot_skip_url=function(){return!1};this.destination_tab=this.originating_tab=this.destination_tabid=this.originating_tabid=null;this.logout=function(){R=S=Z=ga=C=qa=h=null;Cc=0;yb=x=null;e();Ca=Da=!1;p=null;Ba=ia=!1;aa=null;this.clear_event_queue();pa=ea=ka=ca=da=ja=ra=!1};this.initialize=function(a){a?(x=a.tabid,debug&&
(Fc=a.tabid),C=a.recipe,qa=a.aid,h=0,e(),Da=ea=Ca=!1,g_robots_txt&&sendCS(a.tabid,{cmd:"get_robots_txt"},g_CS_tops[a.tabid]),p={},Ba=ia=!1,aa=null,Ga="",eb=sa=db=cb=bb=Ab=zb=!1,ib=0,CPWbot_bg.clear_event_queue(),V=1,rc(),fb=!1,CPWbot_bg.broken_hearted_st_id=null,ta=ya=Ha=O=!1,this.cpw_dialog_minimize_state=Qa=0):console_error("passed invalid params")};this.pwchangetabid_is_still_valid=function(){if(!CPWbot_bg)return!1;var a=x;return null!==a&&g_CS&&"undefined"!=typeof g_CS[a]&&null!==g_CS[a]?!0:!1};
this.panic=function(a){a||(a="UNEXPECTED ERROR");L("panic="+a+", g_pwchangetabid == "+x);CPWbot_bg.do_milestone(x,128,C,a);D(x);CPWbot_bg.cpwbot_cs_finish_complete(x)};this.setmsg_cpwbot_overlay=function(a,b){Va(a,b)};this.initiate_on_complete=function(a,b,c){var d=null;if(!g_cpwbot||!CPWbot_bg||45<c)return CPWbot_bg.do_milestone(a,133,j,"initiate_on_complete"),CPWbot_bg.panic("TIMEOUT-initiate"),null;var f=b.aid,j=b.recipe;if("undefined"==typeof c||null===c)c=1;if(!pc(j)){var d=ua(f),e="(null)";
d&&d.url&&(e=this.JSON.stringify(d.url));n(Wa,"Bad Recipe");f="Error for recipe on aid="+f+", url="+e;CPWbot_bg.phone_home(null,null,{severity:"fatal",msg:"Bad Recipe"});CPWbot_bg.panic(f);return null}if(za)Ac(a,j);else{(j=nc(j))||(j=900);var g=g_CS_tops[a];if(null!==g&&(d=getcsinfo(a,g_CS_tops[a]))&&"complete"==d.docstate)return CPWbot_bg.mark_timestamp("doc_complete"),ping(a),d=c?c*j/1E3:0,isNaN(d)&&verbose_log("WTF NaN: ctr="+c+" url="+e+" aid="+f),w&&(f=w.doc_complete-w.openurl_callback,0<f&&
(0!=w.doc_complete&&w.openurl_callback)&&(d=f/1E3)),0<d&&n(N,"Waited "+d+" seconds for document-complete before calling initialize_engine"),CPWbot_bg.initialize_engine(a,b);if(za||!lploggedin)return L("abort wait-for-doc-complete initiate"),!1;null!==g?ping(a,g):ping(a);verbose_log("waiting for tabid "+a+" topdocnum="+g+" docstate="+(d?d.docstate:"null"));setTimeout(function(){CPWbot_bg.initiate_on_complete(a,b,c+1)},j);return!0}};this.get_user_debug_messages=function(){return Xa};var N=0,K=1,od=
2,Wa=3;this.userlog=function(a,b){return n(a,b)};this.click_ack_handler=function(a,b){var c=b.msgid,d=b.found;L("[T:"+a+"][D:"+b.docnum+"] cpwbot click_ack on "+b.id_value+" found="+d+" url="+b.url+" docstate="+b.docstate+" pwchangestate="+b.pwchangestate);if(aa!=c)return console_error("response for last click request overlaps current click-wait, ignoring it, found="+d),L("m_pwchange_last_click_field_id="+aa),L("found="+d+" msgid = "+c),d&&console_error("Bad Mojo"),!0;d&&(ea&&(ea=!1),oa&&(oa=!1),
ca&&(ca=!1),da&&(da=!1),ra&&(ra=!1),ja&&(ja=!1),ka&&(ka=!1),pa&&(pa=!1));return!0};this.fill_ack_handler=function(a,b){verbose_log(sprintf("[%s][%s] cpwbot fill ack on %s found=%s docstate=%s url=%s req_id=%s",a,b.docnum,b.id_value,b.found,b.docstate?b.docstate:"null",b.url?b.url:"null",b.req_id?b.req_id:"null"));return!0};this.js_ack_handler=function(a,b){var c="";try{c=JSON.parse(b.result)}catch(d){console_warn("js_ack_handler: "+d)}verbose_log(sprintf("[%s][%s] cpwbot js ack result=%s docstate=%s url=%s req_id=%s",
a,b.docnum,c?ofa(c):"null",b.docstate?b.docstate:"null",b.url?b.url:"null",b.req_id?b.req_id:"null"));return!0};this.check_for_robots=function(){};this.check_robot_txt=function(a,b){if(g_robots_txt){if(!a)return!0;if(null===b)g_tmp_recipe=a;else{for(var c,d=0,f=b.split("\n"),j=!1,e=!1,d=0;d<f.length;d++){c=f[d];if(0==c.length&&""==c||"\r"==c)e=j=!1;"#"!=c.charAt(0)&&(0==c.indexOf("User-agent: LastPass")?j=!0:0==c.indexOf("User-agent: *")?j=!0:0==c.indexOf("Disallow: /")&&(e=!0))}return j&&e?!1:!0}}};
this.score_frame=function(a,b){var c=b.docnum,d=b.url,f,j=0,e=lp_gettld_url(d);getname_url(d);var g=0,h="doubleclick.net appads.com crwdcntrl.net googleadservices.com quantserve.com questionmarket.com advertising.com zedo.com checkm8.com zvents.com doubleclick.com yldmgrimg.net optmd.com casalemedia.com scorecardresearch.com quotemedia.com tacoda.net daylife.com brightcove.com wibiya.com clickability.com stats.com google-analytics.com adfusion.com 2mdn.net adsonar.com everyclick.com shopica.com yeah.com vectorportal.com cnomy.com phpbb.com tracking101.com revsci.net revsci.com atdmt.com mmismm.com googlesyndication.com 247realmedia.com pointroll.com bluekai.com serving-sys.com vizu.com cleanprint.com outbrain.com tweetmeme.com visiblemeasures.com starwave.com kaango.com gabriels.net overture.com yieldmanager.net 2mdn.com eyewonder.com imgdownloads.com liverail.com adnxs.com addthis.com addthiscdn.com imshopping.com adtech.de 2o7.net glanceguide.com performgroup.com undertone.com undertonevideo.com martiniadnetwork.com chartbeat.net omtrdc.net zoomflow.com crowdscience.com imrworldwide.com fwmrm.net tremormedia.com webtrends.com adzerk.net adzerk.com qubitproducts.com maxymiser.net maxymiser.com newrelic.com mathtag.com adroll.com criteo.com liveperson.com getclicky.com sitemeter.com displaymarketplace.com yieldmanager.com media6degrees.com betrad.com 360yield.com adpredictive.com burstnet.com adtechus.com adsafeprotected.com turn.com contextweb.com p-td.com lijit.com rubiconproject.com ru4.com admeld.com openx.net pubmatic.com localyokelmedia.com qnsr.com wrating.com audienceiq.com mydas.mobi mopub.com visualrevenue.com adsymptotic.com admob.com adtrking.com 4dsply.com adshostnet.com adziff.com 33across.com vindicosuite.com securepaths.com taboola.com trk4.com crwdcntrl.com connexity.com connexity.net effectivemeasure.net visualdna.com amazon-adsystem.com 4dsply.com".split(" "),
k="ads.cnn.com metrics.post-gazette.com ads.nwsource.com adbox.sina.com.cn ads.sina.com.cn ad.afy11.net avatar.cnn.com ads.cnn.com metrics.apple.com trailers.apple.com metrics.philly.com adsatt.espn.go.com http://player.ooyala.com".split(" "),n=["facebook.com/plugins","http://static.ak.facebook.com/connect/xd_arbiter","https://s-static.ak.facebook.com/connect/xd_arbiter","youtube.com/embed/","http://platform.twitter.com/widget"];g_CS_tops&&g_CS_tops[a]==b.docnum&&(j=100);for(f=0;f<h.length;f++)if(e==
h[f]){j=-100;g=1;break}if(!g)for(f=0;f<k.length;f++)if(0<=d.indexOf(k[f])){j=-100;g=1;break}if(!g)for(f=0;f<n.length;f++)if(0<=d.indexOf(n[f])){j=-100;break}p&&(p[c]=j);return j};this.score_topdoc=function(a,b,c){if(null===p)return!1;(null===p[b]||"undefined"==typeof p[b])&&CPWbot_bg.clear_frame_score(a,b,c);if(a=getcsinfo(a,b))if((state_param=a.flags)&&state_param.has_frameset)return!0;p[b]+=100;return!0};this.clear_frame_score=function(a,b){if(null===p)return!1;p[b]=0;return!0};this.reset_scores=
function(){p=null;return!0};this.skip_frame_by_score=function(a){if(null===p||null===a)return!0;L("skip? docnum ="+a+" score="+p[a]);return 0>p[a]};this.recompute_scores_for_tab=function(){return!0};this.retry_validate=function(a,b){null===b&&(b="all");Z&&(H=[],sendCS(a,Z,b))};this.wait_for_doc_complete=function(a,b,c,d,f,j){function e(a){return s?"complete"==a||"interactive"==a:"complete"==a}var g,k=d.aid,t=null,s=gc(d.recipe);f||(f=0);var p=nc(d.recipe);p||(p=900);var q=g_CS_tops[a];"undefined"==
typeof q&&(q=null);if(null===b||"undefined"==typeof b)b=q;if(null!==b&&(g=getcsinfo(a,b)))if(t=g.docstate,e(g.docstate)&&e(j))return j=f?f*p/1E3:0,isNaN(j)&&verbose_log("WTF NaN: recursion_ctr="+f+" aid="+k),0<j&&n(N,sprintf("Waited %d seconds for %s on [tabid:%s][docnum:%d] to execute %s",j,s?"interactive":"complete",a,b,d.desc)),null!==CPWbot_bg.get_pwchangetabid()&&CPWbot_bg.in_validate()&&(v=!1,L("WAITED DONE, calling "+d.desc+" VALIDATE_IN_DOCWAIT=false")),c(a,d);if(za||!lploggedin||null===h)return L("abort wait-for-doc-complete "+
d.desc),!1;ping(a);verbose_log("waiting for tabid "+a+" topdocnum="+q+" passed_docnum="+b+" docstate="+(g?g.docstate:"null")+" last_state="+j);b!=q&&(console_error("edge case - top docnum changed due to page reload?  will wait for that instead"+b+"!="+q),b=q);setTimeout(function(){CPWbot_bg.wait_for_doc_complete(a,b,c,d,f+1,t)},p);return!0};this.should_wait_for_document_complete=function(a,b){if(null===a||!b)return!1;var c=b.desc,d=b.recipe,f=!0,j=b.fn_url_failed,e=b.fn_url_success,g=b.fn_required,
h=b.fn_rejected,g=g?g(d):[],d=h?h(d):[],h=b.target_url,k=b.target_field,n=b.target_js;if(!("undefined"==typeof h||null===h)||!("undefined"==typeof k||null===k)||!("undefined"==typeof n||null===n))f=!1;if(f){if(0==g.length&&0==d.length&&!e&&!j)return L("should_wait returns false, WARN: "+c+" has no field or url criteria defined to validate against"),!1}else if(!h&&!k&&!n)return L("should_wait returns false, no wait criteria, "+c),!1;L("should_wait returns true for "+c+" is_validate="+f);return!0};
this.handle_challenge=function(){};this.validate_challenge_page=function(a,b){if(!b)return!1;var c={recipe:b,desc:"validate_challenge_form",fn_required:jd,fn_rejected:kd,fn_url_success:Vc,fn_url_failed:Uc};if(CPWbot_bg.should_wait_for_document_complete(a,c))return q=!0,CPWbot_bg.wait_for_doc_complete(a,null,ba,c),null;L("validate_challenge_form returns false, no criteria to check, no wait");return!1};this.force_validate_retry=function(a){ia=a};this.validate_challenge_success=function(a,b){if(!b)return!1;
B(a,b,Lc);var c={recipe:b,desc:"validate_challenge_success",fn_required:ld,fn_rejected:md,fn_url_success:T,fn_url_failed:T};if(CPWbot_bg.should_wait_for_document_complete(a,c))return q=!0,CPWbot_bg.wait_for_doc_complete(a,null,ba,c),null;L("validate_challenge_success returns true, no wait ");return!0};var Ga="";this.set_dialog_msg=function(a){Ga=a;return!0};this.get_dialog_msg=function(){return Ga};this.clear_dialog_msg=function(){Ga="";return!0};this.get_failstate=function(){return bb};this.get_okstate=
function(){return cb};this.get_captchastate=function(){return db};this.get_docaptchastate=function(){return sa};this.get_brokenheartstate=function(){return eb};this.get_failpwsavedstate=function(){return Ia};this.get_fail_pending=function(){return Ca};this.get_success_pending=function(){return Da};this.show_selenium_ok=function(a){tc(a,"OK")};this.show_selenium_fail=function(a){tc(a,"FAIL")};this.preinit=function(){h="preinit";e();Xa=Ga="";null!==CPWbot_bg.broken_hearted_st_id&&clearTimeout(CPWbot_bg.broken_hearted_st_id);
CPWbot_bg.broken_hearted_st_id=null;Ia=cb=eb=bb=sa=db=za=!1};this.do_milestone=function(a,b,c,d){var f=null;c||(c={symbolic:""});if("undefined"==typeof d||null===d)d="";if("undefined"!=typeof Date){var j="",e=(new Date).toString();k[b]&&((f=U(c))||(f=gs("unnamed site")),f=sprintf(k[b],f));switch(b){case 1:case 2:break;case gb:case 8:break;case Bb:verbose_log("C: GOTO ACCTMGMT ");break;case Cb:verbose_log("D: REVEAL");break;case Db:verbose_log("E: TRIGGER");break;case Eb:verbose_log("F: VALIDATE");
break;case wb:Ra(a,c,ga);B(a,c,Qc);sa=!0;g_isfirefox&&Va(a,gs("The website needs you to enter information. Please close this overlay and enter it."),c,!0);hc(a);CPWbot_bg.session_timeout_st_id&&(clearTimeout(CPWbot_bg.session_timeout_st_id),CPWbot_bg.session_timeout_st_id=null);CPWbot_bg.docaptcha_si_id&&clearInterval(CPWbot_bg.docaptcha_si_id);CPWbot_bg.docaptcha_si_id=setInterval(function(){sa&&ba(a,{desc:"docaptcha",recipe:c,fn_required:cc})},1E3);break;case 63:n(K,"Saved and Replaced");cb=!0;
debug&&CPWbot_bg.show_selenium_ok(a);Da=!0;CPWbot_bg.mark_timestamp("success");break;case 65:g_v2engine?n(K,sprintf("[%s] v2 %s",e,gs("BEGIN"))):n(K,sprintf("[%s] %s",e,gs("BEGIN")));break;case 66:g_v2engine?n(K,sprintf("[%s] v2 %s",e,gs("END"))):n(K,sprintf("[%s] %s",e,gs("END")));break;case 67:verbose_log("USER IS ALREADY LOGGED IN, SKIP LOGIN STATE");n(K,"Appears to be Logged Into Site");break;case $b:case Xb:n(K,"Filling Login Form");break;case bc:case Yb:n(K,"Submit Login Form");break;case Dc:n(K,
"Going to Login");verbose_log("B: GOTO LOGIN");break;case Ec:n(K,"Perform Logout");break;case 72:1!=V&&n(K,sprintf("Adjusting for %s site, %6.2f",1<V?"slow":"fast",V));break;case 73:Ia=!0;n(K,"Generated Random Password and Saved to Vault");break;case 128:j="UNEXPECTED ERROR";break;case Fb:j="FILL LOGIN FORM [PW CHALLENGE] FAILED!";break;case Gb:j="SUBMIT LOGIN FORM [PW CHALLENGE] FAILED!";break;case hb:j="Expected Change-Password Form";break;case 135:j="Change Password Failed";break;case va:j="Expected Login Form";
break;case Ea:case Fa:j="Login to Website Failed!";break;case 136:j="Unable to Save New Password";break;case Hb:j="Unable to Log Out of Website";break;case 133:j=gs("Timed out waiting for the page to load.  Retry?");eb=!0;break;case 140:j="Session Timeout";break;case vb:j="Halt Requested";break;case xb:db=!0;j="Interaction required; cannot proceed";break;default:f=""}128==(b&128)?(bb=!0,n(Wa,j),debug&&CPWbot_bg.show_selenium_fail(a),Ca=!0,CPWbot_bg.mark_timestamp("fail"),d={severity:"fatal",msg:sprintf("%s[debug=%s]",
j,d)},CPWbot_bg.phone_home(a,c,d),Ia&&(f=sprintf(k[248],U(c)))):64==(b&64)&&(f="");f&&(Va(a,f,c),CPWbot_bg.set_dialog_msg(f));CPWbatch&&CPWbatch.cpw_get_batchjob_state();CPWbatch&&CPWbatch.conditional_website_status_update({tabid:a,recipe:c,state:b,msg:f});return!0}};var Gc=null,ha=null,qb=null,q=!1,q=!1,ib=0,la=[],O=!1,Ha=!1,ya=!1,ta=!1,jb=!1,Ja=!1,Ka=!1,La=!1,Ma=!1,Na=!1,Oa=!1,v=null,P=null,y={},W=null,ec=null,fc=null,Fc=null,Wb=null,nb=null,Qa=0,nd=10,Ib=null,za=!1,Ia=!1;this.docaptcha_si_id=this.session_timeout_st_id=
this.broken_hearted_st_id=null;this.engine=function(a,b,c){var d,f;function e(a){debug&&(a=sprintf("[%s][%s] : %s",(new Date).toString(),"engine",a),console_log(a))}function g(a,b,c){var d;d={aid:c.aid,recipe:c.recipe};verbose_log("do_C "+h);CPWbot_bg.do_milestone(a,Bb,b);d={desc:"navigate_to_acctmgmt",didcallout:!1,payload:d,recipe:b,target_field:G(b,FN_NAVIGATE_TO_ACCTMGMT),target_js:Jb(b)+""+lb(b),target_url:!b?null:b.acctmgmt_url};CPWbot_bg.should_wait_for_document_complete(a,d)?(L("wrapped navigate_to_acctmgmt around wait-for-document-complete"),
ya=d.didcallout=!0,CPWbot_bg.wait_for_doc_complete(a,null,function(a,b){L("Cnav milestone");h="Cnav";W=b},d),d=null):(d.didcallout=!1,L("execute navigate_to_acctmgmt, no wait "),d=CPWbot_bg.navigate_to_acctmgmt(a,d));if(null===d)return L("callout to CS : navigate_to_acctmgmt"),d;!1===d&&console_error("C error");L("execute navigate_to_acctmgmt, no wait ");return s(a,b,c)}function k(a,b,c){F=!1;var d=jc(b);d||(d=2500);if(d&&!La)return h="Csleep",L("C sleeping "+d),F=!0,ha=$+d,La=!0,null;La=!0;$a&&B(a,
b,lb);return s(a,b,c)}function s(a,b,c){verbose_log("do_D "+h);var d;d={aid:c.aid,recipe:c.recipe};ta=!1;CPWbot_bg.do_milestone(a,Cb,b);d={desc:"reveal_cpw",payload:d,recipe:b,didcallout:!1,target_field:G(b,FN_NAVIGATE_TO_CPW),target_js:Pa(b)+""+kb(b),target_url:!b?null:b.cpw_url};CPWbot_bg.should_wait_for_document_complete(a,d)?(L("wrapped reveal_cpw around wait-for-document-complete"),ta=d.didcallout=!0,CPWbot_bg.wait_for_doc_complete(a,null,function(a,b){L("Dreveal milestone");h="Dreveal";W=b},
d),d=null):(d.didcallout=!1,L("execute reveal_cpw, no wait "),d=CPWbot_bg.reveal_cpw(a,d));if(d)return L("execute reveal_cpw, no wait "),C(a,b,c);L("callout to CS : reveal_cpw");return d}function p(a,b,c){F=!1;var d=kc(b);d||(d=2500);if(d&&!Ma)return h="Dsleep",L("D sleeping "+d),F=!0,ha=$+d,Ma=!0,null;Ma=!0;Za&&B(a,b,kb);L("entered do_D1");d={aid:c.aid,recipe:b};h="D1";var e=null,e=CPWbot_bg.validate_cpw_form(a,b,d);null===e?(verbose_log("D1: validate_cpw_form / CS callout "),v=!0,L("VALIDATE_IN_DOCWAIT=true"),
a=null):a=e?void 0:u(a,b,c);return a}function u(a,b,c){var d={aid:c.aid,recipe:b};h="D2";var e=null,e=CPWbot_bg.validate_login_form(a,b,d);if(null===e)return v=!0,L("VALIDATE_IN_DOCWAIT=true"),verbose_log("D2: validate_login_form / CS callout "),null;if(aa)return x(a,b,c);CPWbot_bg.do_milestone(a,hb,b,"");D(a);return!1}function x(a,b,c){h="D4";verbose_log("D4: FILL LOGIN/CHALLENGE");var d=null,d=Ra(a,b,Q);if(!d)return CPWbot_bg.do_milestone(a,Fb,b,""),D(a),!1;verbose_log("D5: SUBMIT LOGIN");h="D5";
var d=1100,e=tb(b);e&&(d=e);d&&verbose_log("waiting "+d+" ms after login waiting for site to bootstrap");e=pb(a,b,Q);!1===e?(CPWbot_bg.do_milestone(a,Gb,b,""),D(a),a=!1):null===e?(d&&(F=!0,ha=$+d),a=null):a=C(a,b,c);return a}function C(a,b,c){verbose_log("do_E "+h);var d;d={aid:c.aid,recipe:c.recipe};CPWbot_bg.do_milestone(a,Db,b);d={desc:"trigger_cpw",payload:d,recipe:b,target_field:G(b,FN_CPW_SUBMIT),target_js:Kb(b)+""+Lb(b),target_url:null};CPWbot_bg.should_wait_for_document_complete(a,d)?(L("wrapped trigger_cpw around wait-for-document-complete"),
Ha=d.didcallout=!0,CPWbot_bg.wait_for_doc_complete(a,null,function(a,b){L("Etrigger milestone");h="Etrigger";W=b},d),d=null):(d.didcallout=!1,L("execute trigger_cpw, no wait "),d=CPWbot_bg.trigger_cpw(a,d));if(d)return L("execute trigger_cpw, no wait "),A(a,b,c);L("callout to CS : trigger_cpw");return d}function A(a,b,c){F=!1;var d;d=0;b?"undefined"!=typeof b.posttrigger_sleep&&(d=b.posttrigger_sleep):d=null;d||(d=2500);if(d&&!Na)return h="Esleep",L("E sleeping "+d),F=!0,ha=$+d,Na=!0,null;Na=!0;c.validate_result=
null;CPWbot_bg.mark_timestamp("verify_cpw");CPWbot_bg.do_milestone(a,Eb,b);h="F";null===CPWbot_bg.validate_cpw_success(a,b,Q)?(verbose_log("F: VALIDATE callout to CS"),v=!0,L("VALIDATE_IN_DOCWAIT=true"),a=null):(verbose_log("F: VALIDATE no callout to CS"),vc("no verify-cpw criteria defined"),CPWbot_bg.panic("fail"),a=!1);return a}function H(a,b,c){CPWbot_bg.do_milestone(a,gb,b);var d=G(b,FN_REVEAL_LOGIN);return d?(h="A3R",verbose_log("A3R: login-form-reveal"),c=DEFAULT_CLICK_DELAY,"undefined"!=typeof b.login_reveal_delay&&
(c=b.login_reveal_delay),ra=!0,L("now waiting for click_ack A3R"),na(a,d,c),CPWbot_bg.mark_timestamp("wait_for_click_ack_A3R"),null):J(a,b,c)}function J(a,b,c){L("post_A3R");F=!1;var d=sb(b);verbose_log("A3R sleepval="+d);d||(d=1E3);if(d&&!Ja)return h="A3Rsleep",L("A3R sleeping "+d),F=!0,ha=$+d,Ja=!0,null;Ja=!0;c.validate_result=null;verbose_log("calling reveal JS after A3 state");B(a,b,mb);return M(a,b,c)}function M(a,b,c){CPWbot_bg.do_milestone(a,gb,b);var d=!0;"undefined"!=typeof c.check_login_entry_form&&
(d=c.check_login_entry_form?!0:!1);h="A3";if(d){var d=[],e=[FN_LOGIN_ENTRY_USERNAME,FN_LOGIN_ENTRY_PASSWORD,FN_LOGIN_ENTRY_SUBMIT],f;for(f=0;f<e.length;f++){var g=E(b,e[f]);g&&0<g.length&&(d=d.concat(g))}}if(d){verbose_log("M: validate_login_entry_form");CPWbot_bg.mark_timestamp("login_entry");h="M";d=null;verbose_log("calling validate_login_entry_form");d=CPWbot_bg.validate_login_entry_form(a,b,Q);if(null===d)return verbose_log("M: validate_login_entry_form / CS callout "),v=!0,L("VALIDATE_IN_DOCWAIT=true"),
null;verbose_log("M: validate_login_entry_form returns "+d+" no call to CS")}verbose_log("A3: validate_login_form");h="A3";d=null;verbose_log("calling validate_login_form");d=CPWbot_bg.validate_login_form(a,b,Q);if(null===d)return verbose_log("A3: validate_login_form / CS callout "),v=!0,L("VALIDATE_IN_DOCWAIT=true"),null;verbose_log("A3: validate_login_form returns "+d+" no call to CS");return d?N(a,b,c):Y(a,b,c)}function N(a,b,c){CPWbot_bg.mark_timestamp("login_cpw");verbose_log("A4: FILL LOGIN");
h="A4";var d=null,d=Ra(a,b,Q);if(!d)return CPWbot_bg.do_milestone(a,va,b,""),D(a),!1;verbose_log("A5: SUBMIT LOGIN");h="A5";var d=1100,e=tb(b);e&&(d=e);d&&verbose_log("waiting "+d+" ms after login waiting for site to bootstrap");e=pb(a,b,Q);!1===e?(CPWbot_bg.do_milestone(a,Ea,b,""),D(a),a=!1):null===e?(d&&(F=!0,ha=$+d),a=null):a=T(a,b,c);return a}function T(a,b,c){verbose_log("A2: validate_login_success ");h="A2";var d=null,d=CPWbot_bg.validate_login_success(a,b,Q);if(null===d)return verbose_log("A2: validate_login_success / CS callout "),
v=!0,L("VALIDATE_IN_DOCWAIT=true"),null;verbose_log("A2: validate_login_success "+d+" no CS callout ");if(d)g(a,b,c);else return CPWbot_bg.do_milestone(a,Ea,b,X),D(a),retval}function Y(a,b,c){CPWbot_bg.mark_timestamp("navlogin_cpw");Cc++;CPWbot_bg.do_milestone(a,Dc,b);CPWbot_bg.navigate_to_login(a,{aid:c.aid,recipe:c.recipe})&&U(a,b,c)}function U(a,b,c){verbose_log("post_B");F=!1;var d=sb(b);d||(d=1E3);if(d&&!Ka)h="Bsleep",L("B sleeping "+d),F=!0,ha=$+d,Ka=!0;else{Ka=!0;c.desc="post_B/Breveal";c.validate_result=
null;if(g_v2engine||Ya)verbose_log("calling reveal JS after B state"),B(a,b,mb);jb=!0;CPWbot_bg.wait_for_doc_complete(a,null,function(a,b){L("B-reveal milestone");h="B1Rpre";W=b},c)}}function ia(a,b,c){CPWbot_bg.do_milestone(a,Ec,b);h="L";CPWbot_bg.mark_timestamp("logout_cpw");var d=CPWbot_bg.navigate_to_logout(a,c);null===d?verbose_log("L: navigate_to_logout / CS callout "):d?H(a,b,c):(CPWbot_bg.do_milestone(a,Hb,b,""),D(a));return!0}function ma(a,b,c){L("post_L");F=!1;var d=lc(b);d||(d=1E3);if(d&&
!Oa)return h="Lsleep",L("L sleeping "+d),F=!0,ha=$+d,Oa=!0,null;Oa=!0;ab&&B(a,b,Qb);return H(a,b,c)}function z(a,b,c){verbose_log("M2: validate_login_entry_success ");h="M2";var d=null,d=CPWbot_bg.validate_login_entry_success(a,b,Q);if(null===d)return verbose_log("M2: validate_login_entry_success / CS callout "),v=!0,L("VALIDATE_IN_DOCWAIT=true"),null;verbose_log("M2: validate_login_entry_success "+d+" no CS callout ");if(d)c.check_login_entry_form=!1,M(a,b,c);else return CPWbot_bg.do_milestone(a,
Fa,b,X),D(a),retval}var m=c.aid,l=c.recipe,$=(new Date).getTime();d=!1;if(0==ib){CPWbot_bg.mark_timestamp("initial_cycle");var r;w&&(r=w.initial_cycle-w.dopwchange,1E4<r&&(0!=w.initial_cycle&&0!=w.dopwchange)&&(V=2,yc(l,V)));CPWbot_bg.do_milestone(a,72,l);null!==CPWbot_bg.broken_hearted_st_id&&clearTimeout(CPWbot_bg.broken_hearted_st_id);CPWbot_bg.broken_hearted_st_id=null;uc(a,l)}ib++;e("engine awaken tick="+ib);if(null===h)D(a);else if(za||!lploggedin)Ac(a,l);else{if(!sa){(r=ub(l))||(r=DEFAULT_SESSION_TIMEOUT);
var I=CPWbot_bg.get_timestamp("docaptcha_success");I||(I=CPWbot_bg.get_timestamp("initial_cycle"));I||(I=Gc);if($>I+r*V){d=!0;CPWbot_bg.do_milestone(a,140,l,"engine");CPWbot_bg.panic("TIMEOUT-engine");return}}r=Ua(l);if(q&&0<qb&&$>qb+r){a:{for(r=0;r<la.length;r++)if(I=la[r],"validate_response"==I.type){r=!0;break a}r=!1}r?pass:(v=!1,L("ENGINE - VALIDATE_IN_DOCWAIT=false"),CPWbot_bg.finish_cpwbot_validate_state(a,R,ec,fc,S))}if(b&&F)if($>ha)e("AWAKEN FROM SLEEP");else{e("CONTINUE SLEEPING");wa(a,h,
c);return}b=null;for(b=0;b<la.length;b++)switch(r=la[b],I=r.data.docnum,e(sprintf("[%s][%d] processing event#%d cmd=%s",a,I,b,r.data.cmd)),r.type){case "validate_response":CPWbot_bg.cpwbot_validate_state_result_handler(r.tabid,r.data);break;case "fill_ack":CPWbot_bg&&CPWbot_bg.fill_ack_handler(r.tabid,r.data);break;case "click_ack":CPWbot_bg&&CPWbot_bg.click_ack_handler(r.tabid,r.data);break;case "js_ack":CPWbot_bg&&CPWbot_bg.js_ack_handler(r.tabid,r.data);break;case "finish_ack":CPWbot_bg&&CPWbot_bg.cpwbot_finish_ack_handler(r.tabid,
r.data);break;case "loadurl":if(g_CS_tops&&g_CS_tops[a]==I)switch(O&&(O=!1,e("m_in_loadurl cleared")),e("loadurl/setprefs against top :"+g_CS_tops[a]+" == "+I+" start_state="+CPWbot_bg.get_pwchangestate()),h){case "A1":case "A2":case "A3":case "M":case "B1":case "F":CPWbot_bg&&Z&&(CPWbot_bg.force_validate_retry(!0),CPWbot_bg.retry_validate(a));break;case 0:case "0":e("engine called in initial state - ignoring")}else if(null!==CPWbot_bg.get_pwchangetabid()&&CPWbot_bg.in_validate())L("processing loadurl event, reissue last validate to new doc ["+
a+"]["+I+"]"),CPWbot_bg.retry_validate(a,I);else if(null!==CPWbot_bg.get_pwchangetabid()&&(ea||ca||da||oa||ka||pa||ra||ja))L("loadurl sent while waiting for a click, issue last click to new frame"+I),xc(a,I);break;case "unload":break;default:e("need to handle this msg: "+r.data.cmd)}CPWbot_bg.clear_event_queue();e("current state is "+h);var Q=ga;h&&null===Q&&(Q={aid:m});switch(h){case 0:h="A1";m=CPWbot_bg.check_is_logged_in(a,l,Q);null===m?(verbose_log("A1: check_is_logged_in / CS callout "),v=!0,
L("VALIDATE_IN_DOCWAIT=true")):(verbose_log("A1: check_is_logged_in returns "+m+" no CS callout "),(b=P)?ia(a,l,c):H(a,l,c));break;case "A1":CPWbot_bg.in_validate()||v?(e("waiting for validate to end, "+h),pass):ya?(e("waiting for doc-complete for Cnav, "+h),pass):q?e("A1: wait on m_in_validate"):(m=b=P)?(CPWbot_bg.do_milestone(a,67,l),ia(a,l,c)):null===m?CPWbot_bg.alert("A1 unexpected"):H(a,l,c);break;case "A3R":ra?(e("waiting for click_ack, "+h),fa(a),pass):O?(e("waiting for loadurl , "+h),pass):
J(a,l,c);break;case "B1Rpre":ja=!1;(m=G(l,FN_REVEAL_LOGIN))?(h="B1R",verbose_log("B1R: login-form-reveal"),verbose_log("click on FN_REVEAL_LOGIN field!"),b=DEFAULT_CLICK_DELAY,"undefined"!=typeof l.login_reveal_delay&&(b=l.login_reveal_delay),ja=!0,verbose_log("now waiting for click_ack B1R"),na(a,m,b),CPWbot_bg.mark_timestamp("wait_for_click_ack_B1R")):wc(a,l,c);break;case "B1R":ja?(e("waiting for click_ack, "+h),fa(a),pass):O?(e("waiting for loadurl , "+h),pass):q?e("B1R: wait on m_in_validate"):
wc(a,l,c);break;case "B1":if(CPWbot_bg.in_validate()||v)e("waiting for validate to end, "+h),pass;else if(q)e("B1: wait on m_in_validate");else{m=b=P;if(y&&y.found_interactive){console_error("B1: found interactive field");xa(a,l);return}if(m)N(a,l,c);else{debug&&(g_innerHTML_debug&&y.innerHTML)&&verbose_log("VALIDATE FAILURE, final innerHTML is "+y.innerHTML);var X="";CPWbot_bg.do_milestone(a,va,l,X);D(a);return}}break;case "A2":if(CPWbot_bg.in_validate()||v)e("waiting for validate to end, "+h),pass;
else if(q)e("A2: wait on m_in_validate");else if(ya)e("A2: wait on navigate");else{if(y&&y.found_interactive){console_error("A2: found interactive field");xa(a,l);return}if(b=P)g(a,l,c);else{X="";CPWbot_bg.do_milestone(a,Ea,l,X);D(a);return}}break;case "A3":if(CPWbot_bg.in_validate()||v||q)e("waiting for validate to end, "+h),pass;else{m=b=P;if(y&&y.found_interactive){console_error("A3: found interactive field");xa(a,l);return}m?(e("A3: has login form, calling do_A4"),y&&y.found_interactive&&e("A3: found_interactive=true"),
N(a,l,c)):(debug&&(g_innerHTML_debug&&y.innerHTML)&&verbose_log("VALIDATE FAILURE, final innerHTML is "+y.innerHTML),Y(a,l,c))}break;case "M":if(CPWbot_bg.in_validate()||v||q)e("waiting for validate to end, "+h),pass;else{m=b=P;if(y&&y.found_interactive){console_error("M: found interactive field");xa(a,l);return}m?(CPWbot_bg.mark_timestamp("login_entry"),verbose_log("M4: FILL LOGIN"),h="M4",m=null,(m=Zb(a,l,Q))?(verbose_log("M5: SUBMIT LOGIN ENTRY"),h="M5",m=1100,(b=tb(l))&&(m=b),m&&verbose_log("waiting "+
m+" ms after login waiting for site to bootstrap"),b=ac(a,l,Q),!1===b?(CPWbot_bg.do_milestone(a,Fa,l,""),D(a)):null===b?m&&(F=!0,ha=$+m):z(a,l,c)):(CPWbot_bg.do_milestone(a,va,l,""),D(a))):(verbose_log("did not find initial stage login form"),y.innerHTML&&verbose_log("final innerHTML is "+y.innerHTML),c.check_login_entry_form=!1,M(a,l,c))}break;case "M2":if(CPWbot_bg.in_validate()||v)e("waiting for validate to end, "+h),pass;else if(q)e("M2: wait on m_in_validate");else if(ya)e("M2: wait on navigate");
else{if(y&&y.found_interactive){console_error("M2: found interactive field");xa(a,l);return}if(b=P)c.check_login_entry_form=!1,M(a,l,c);else{X="";y&&(X=sprintf("found_bad_match=%s, num_ok_matches=%s, retval=%s, url_success_match=%s, url_failure_match=%s",y.found_bad_match,y.num_ok_matches,y.retval,y.url_success_match,y.url_failure_match));CPWbot_bg.do_milestone(a,Fa,l,X);D(a);return}}break;case "A4":break;case "A5":T(a,l,c);break;case "M5":z(a,l,c);break;case "A":console_warn("engine state=A todo");
break;case "B":O?(e("waiting for loadurl to complete, "+h),pass):jb?(e("waiting for doc-complete after loadurl, "+h),pass):U(a,l,c);break;case "Bsleep":jb?(e("waiting for doc-complete after loadurl, "+h),pass):U(a,l,c);break;case "C":da?(e("waiting for click_ack, "+h),fa(a),pass):O?(e("waiting for loadurl , "+h),pass):ta?(e("waiting for reveal-cpw doc-complete, "+h),pass):(m=g_CS_tops[a],"undefined"==typeof m&&(m=null),b=null,null!==m?(b=getcsinfo(a,m))?(r=b.docstate,"complete"==b.docstate&&"complete"==
r?(e("C: wait completed "+h),k(a,l,c)):e("C: wait docstate:"+b.docstate+",last:"+r)):e("C: fail"):e("C: wtf - wait for page to finish loading?"),null!==m?ping(a,m):ping(a));break;case "Cnav":L("aid = "+W.payload.aid);CPWbot_bg.navigate_to_acctmgmt(a,W);W=null;break;case "Cpickup":da&&(L("still waiting for click-C"),e("waiting for click_ack, "+h),fa(a));ta?L("still waiting for document-complete to run reveal_cpw"):k(a,l,c);break;case "A3Rsleep":J(a,l,c);break;case "B1Rsleep":M(a,l,c);break;case "Csleep":ta?
L("still waiting for document-complete to run reveal_cpw"):k(a,l,c);break;case "Dpickup":ca?(L("still waiting for click-D"),e("waiting for click_ack, "+h),fa(a)):p(a,l,c);break;case "Dsleep":p(a,l,c);break;case "Epickup":ea?(L("still waiting for click-E"),e("waiting for click_ack, "+h),fa(a)):(c.validate_result=null,A(a,l,c));break;case "Esleep":c.validate_result=null;A(a,l,c);break;case "D":e("engine handle D");ca||O?(ca?(e("waiting for click_ack, "+h),fa(a)):e("waiting for load to complete, "+h),
pass):(m=g_CS_tops[a],"undefined"==typeof m&&(m=null),b=null,null!==m?(b=getcsinfo(a,m))?(r=b.docstate,"complete"==b.docstate&&"complete"==r?(e("D: wait completed "+h),p(a,l,c)):e("D: wait docstate:"+b.docstate+",last:"+r)):e("D: fail"):e("D: wtf - wait for page to finish loading?"),null!==m?ping(a,m):ping(a));break;case "Dreveal":CPWbot_bg.reveal_cpw(a,W);W=null;break;case "D1":if(CPWbot_bg.in_validate()||v)e("waiting for validate to end, "+h),pass;else if(q)e("D1: wait on m_in_validate");else if(Ha)e("D1: wait on doc-complete for trigger_cpw");
else{m=b=P;if(y&&y.found_interactive){console_error("D1: found interactive field");xa(a,l);return}m?C(a,l,c):u(a,l,c)}break;case "D2":if(CPWbot_bg.in_validate()||v)e("waiting for validate to end, "+h),pass;else if(q)e("D2: wait on m_in_validate");else if(b=P)x(a,l,c);else{X="";CPWbot_bg.do_milestone(a,hb,l,X);D(a);return}break;case "D4":break;case "D5":oa?(e("waiting for click_ack, "+h),fa(a)):Ha?e("D5: wait on doc-complete for trigger_cpw"):C(a,l,c);break;case "D3":console_error("D3 reached - should not happen");
break;case "D_validate_cpw_form":ba(a,W);W=null;break;case "E":console_error("E: should not occur");break;case "Etrigger":ea?(e("waiting for click_ack, "+h),fa(a)):O?console_error("Etrigger: m_in_loadurl should not happen"):q?console_error("Etrigger: m_in_validate should not happen"):(CPWbot_bg.trigger_cpw(a,W),W=null);break;case "F":if(CPWbot_bg.in_validate()||v)e("waiting for validate to end, "+h),pass;else if(O)e("waiting for loadurl and doc-complete"),pass;else if(q)e("F: wait on m_in_validate"),
pass;else{CPWbot_bg.bagration();var aa=b=P;if(null!==aa)if(verbose_log("F: VALIDATE return from CS, returned "+aa),debug&&(g_innerHTML_debug&&P.innerHTML&&!aa)&&verbose_log("VALIDATE FAILURE, final innerHTML is "+P.innerHTML),X="",aa){verbose_log("cpwbot initiate: validate cpw succeeded, now updating user record");f=Q;if(!l||!f)d=!1;else if(n(K,"Updating with New Password"),b=!0,r=f.aid,console_log("cpwbot initiate: save_replace for aid="+r),I=ua(r)){d=lpdec_acct(f.newpw,I,"undefined"==typeof g_shares?
lpshares:g_shares);f=lpdec_acct(f.curpw,I,"undefined"==typeof g_shares?lpshares:g_shares);if(I&&d&&f)if(I.pwprotect&&(b=!1),console_log("cpwbot initiate: calling changepw logic for aid="+r),g_isfirefox)(b||LP.securityPrompt())&&lpchangepw(null,d,r,null,null,null,!0);else{var qa={singleaid:r.toString(),newpw:d,autochange:1};b?changepw_wrapper(qa):security_prompt(function(){changepw_wrapper(qa)})}else verbose_log("no passwords to save? acct.aid = "+(I?I.aid:"null")+" cur="+(g_show_pw_in_logs||g_isadmin?
f:"REDACTED")+" newpw="+(g_show_pw_in_logs||g_isadmin?d:"REDACTED"));d=!0}else Aa("given invalid aid - data consistency error?"),d=!1;d?(CPWbot_bg.do_milestone(a,63,l),d=ua(m),d=lpdec_acct(yb,d,"undefined"==typeof g_shares?lpshares:g_shares),m=lp_gettld_url(!l?null:l.login_url),verbose_log('remember to g_didchangepw for pw="'+(g_show_pw_in_logs||g_isadmin?d:"REDACTED")+'" tld='+m),remember_changed_pw(d,m)||verbose_log('save to g_didchangepw failed for pw="'+(g_show_pw_in_logs||g_isadmin?d:"REDACTED")+
'" tld='+m),Ob(l)&&(d=1234,m=0,l?"undefined"!=typeof l.js_finish_delay&&(m=l.js_finish_delay):m=null,m&&(d=m),setTimeout(function(){CPWbot_bg.conditional_js_exec(a,l,Ob)},d)),console_error("The End.")):CPWbot_bg.do_milestone(a,136,l,X)}else CPWbot_bg.do_milestone(a,135,l,X);D(a);d=!0}break;case "G":break;case "L":ka?(e("waiting for click_ack, "+h),fa(a),pass):O?(e("waiting for loadurl , "+h),pass):(m=g_CS_tops[a],"undefined"==typeof m&&(m=null),b=null,null!==m&&((b=getcsinfo(a,m))?"complete"==b.docstate&&
(e("L: wait completed "+h),ma(a,l,c)):e("L: fail")),null!==m?ping(a,m):ping(a));break;case "Lsleep":ma(a,l,c);break;case "Bagration":break;default:pass}d||wa(a,h,c)}};this.initialize_engine=function(a,b){Gc=(new Date).getTime();var c=b.recipe;ga=b;CPWbot_bg.mark_timestamp("initialize_engine");Ia=q=F=Oa=Na=Ma=La=Ka=Ja=m_in_logout_reveal=jb=ta=ya=Ha=O=!1;CPWbot_bg.do_milestone(a,65,c);var d;d=0;c?"undefined"!=typeof c.start_delay&&(d=c.start_delay):d=null;if(d)zb||(zb=!0,setTimeout(function(){wa(a,
0,b);return!1},d));else if(Pb(c)&&!Ab){d=5E3;var e;e=0;c?"undefined"!=typeof c.post_js_begin_delay&&(e=c.post_js_begin_delay):e=null;e&&(d=e);Ab=!0;verbose_log("initial JS inject before beginning - inject, and wait ");CPWbot_bg.conditional_js_exec(a,c,Pb);setTimeout(function(){wa(a,0,b);return!1},d)}else wa(a,0,b)};this.push_event_queue=function(a,b,c){if("validate_response"==a&&"undefined"!=typeof c.desc&&"docaptcha"==c.desc)sa&&0<JSON.parse(c.result_obj).num_ok_matches&&(CPWbot_bg.mark_timestamp("docaptcha_success"),
B(b,C,Rc),sa=!1,CPWbot_bg.show_cpwbot_overlay(b,null,null),uc(b,C),Z=null,q=!1,y.found_interactive=!1,P=!0,wa(b,h,ga));else{var d={};d.type=a;d.data=c;d.tabid=b;d.docnum=c.docnum;d.addtime=new Date;null===la&&(la=[]);verbose_log(sprintf("[%s][%d] pushed event : %s cmd=%s",b,d.docnum,a,c.cmd));la.push(d)}};this.clear_event_queue=function(){la=[]};this.select_execute=function(){};this.select=function(){};this.bagration=function(){h="Bagration"};this.in_bagration=function(){return"Bagration"==h};this.get_selenium_tabid=
function(){return Fc};this.navigate_to_logout=function(a,b){if(!b)return!1;h="L";ab=!1;var c=b.recipe;if(!c)return!1;var d=!1,e=!1,e=B(a,c,Mc);n(K,"Navigate to Logout");var g=J(c);if(g)return L("call logout:loadurl with "+g),e=null,g_CS_tops&&(e=g_CS_tops[a]),sendCS(a,{cmd:"loadurl",url:g},e),O=!0,verbose_log("m_in_loadurl set"),C=c,ga=b,ab=!0,null;ka=!1;if(g=G(c,FN_NAVIGATE_TO_LOGOUT))verbose_log("click on FN_NAVIGATE_TO_LOGOUT field!"),d=DEFAULT_CLICK_DELAY,"undefined"!=typeof c.logout_delay&&(d=
c.logout_delay),ka=!0,verbose_log("now waiting for click_ack L"),na(a,g,d),CPWbot_bg.mark_timestamp("wait_for_click_ack_L"),d=null;g=!1;c?"undefined"!=typeof c.logout_js_delay&&(g=c.logout_js_delay?!0:!1,"0"===c.logout_js_delay&&(g=!1)):g=null;if(g&&(ab=!0,lc(c)))return null;e=e||B(a,c,Qb);!1===d&&e&&(d=!0);return d};var V=1,w=null;this.get_timestamp=function(a){if(!a)return null;null===w&&(w=new zc);return w[a]};this.get_timestamps=function(){return w};this.mark_timestamp=function(a){if(null===w||
"dopwchange"==a)w=new zc;var b=(new Date).getTime();w[a]=b;return!0};this.dump_timestamps=function(){var a;if(w)for(a in w)L(sprintf("[%s] timestamp %s : %d",U(C),a,w[a]));yc(C,V);return!0};this.get_last_timestamp=function(a){var b,c="dopwchange";if(w){for(b in w)if(!a||!("fail"===b||"finish_complete"==b||"success"==b))w[b]>w[c]&&(c=b);return c}return null};this.broken_hearted=function(a){if(CPWbot_bg)if(a!=CPWbot_bg.get_session())n(N,"stale setTimeout - clearTimeout did not work");else if(a=CPWbot_bg.get_timestamp("initial_cycle"),
(new Date).getTime(),"undefined"==typeof a&&(a=null),!a&&("preinit"==h||!h)&&!CPWbot_bg.get_okstate()&&!CPWbot_bg.get_failstate()&&!CPWbot_bg.in_bagration())CPWbot_bg.do_milestone(x,133,C,"brokenhearted"),CPWbot_bg.panic("TIMEOUT-brokenhearted")};this.new_session=function(a){a||(a="");var b=(new Date).getTime();null===b&&(b=0);return Ib=("function"==typeof lp_sha256?lp_sha256:SHA256)(a.toString()+b.toString())};this.get_session=function(){return Ib};this.clear_session=function(){Ib=""};this.halt=
function(){null!==CPWbot_bg.docaptcha_si_id&&clearInterval(CPWbot_bg.docaptcha_si_id);CPWbot_bg.docaptcha_si_id=null;za=!0;L("Halt Requested")};this.cpw_dialog_minimize_state=0;this.getpwchangeaid=function(){return qa};this.phone_home=function(a,b,c){if(!c)return!1;b||(b=C);var d=(new Date).getTime();a=(d-CPWbot_bg.get_timestamp("dopwchange"))/1E3;if(0>a||isNaN(a))a=0;d=(d-CPWbot_bg.get_timestamp("initial_cycle"))/1E3;if(0>d||isNaN(d))d=0;var e=CPWbot_bg.get_last_timestamp(!0),g=c.msg?c.msg:"";b=
sprintf("[%s][%s][R=%s][L=%s][M=%s][%6.2fsec elapsed][%2.1f TF][%6.2fsec TiE]","cpw",c.severity?c.severity:"",b?U(b):"bad-recipe",e,g,a,V,d);L(b);lpReportError(b,null);return!0};this.warning_phone_home=function(a){return Aa(a)};this.site_html_url="";"undefined"!=typeof g_iscasper&&g_iscasper&&(this.get_validate_timeout=function(a){return Ua.apply(this,arguments)},this.get_symbolic=function(a){return U.apply(this,arguments)},this.get_logout_url=function(a){return J.apply(this,arguments)},this.get_generate_prefs_from_recipe=
function(a){return ic.apply(this,arguments)},this.set_last_overlay_message=function(a){return g.apply(this,arguments)},this.clear_last_overlay_message=function(a){return e.apply(this,arguments)},this.validate_xpath=function(a){return oc.apply(this,arguments)},this.validate_recipe=function(a){return pc(a)},this.get_cpw_login_password_field=function(a){return M.apply(this,arguments)},this.get_cpw_login_username_field=function(a){return s.apply(this,arguments)},this.set_pwchangestate=function(a){h=a;
return!0},this.in_wait_for_click=function(){return ea||ca||da||oa||ka||pa||ra||ja},this.submit_login_form=function(a,b,c){return pb(a,b,c)},this.fill_login_form=function(a,b,c){return Ra(a,b,c)},this.clear_wait_for_clicks=function(){return rc()},this.get_event_queue=function(){return la},this.reset_private_test_vars=function(){v=q=fb=!1},this.should_click_on_fill=function(a){return Sa(a)},this.should_fill_password_fields_via_keys=function(a){return Ta(a)},this.get_fill_delay=function(a){return mc(a)},
this.random_delay=function(a){return Y(a)},this.random_sleep=function(a,b){var c;(c=a)||(c=100);typeof("undefined"==b)||null==b||"undefined"==typeof Math?c=!1:(c=random(c)+10,setTimeout(b,c),c=!0);return c},this.get_cpw_session_timeout=function(a){return ub(a)},this.fill_login_entry_form=function(a,b,c){return Zb(a,b,c)},this.submit_login_entry_form=function(a,b,c){return ac(a,b,c)},this.set_pwchange_validate_desc=function(a){S=a;return!0},this.check_recipe_symbols=function(a){return qc(a)},this.set_in_validate_outer=
function(){return v=q=!0},this.set_in_validate_inner=function(a,b){Z={cmd:"cpwbot_validate_state",desc:b,id:a};R=a;Bc.set_pwchange_validate_desc(b);null===H&&(H=[])},this.get_in_sleep=function(){return F},this.clear_sleeps=function(){F=Oa=Na=Ma=La=Ka=Ja=!1});return!0}
function get_recipe_for_url(g,e){lp_gettld_url(g);var J,M;g_isfirefox?(J=LP.lpMakeRequest,M=LP.lp_base):(J=lpMakeRequest,M=base_url);J(M+"get_recipe.php","url="+encodeURIComponent(g),function(g){if(4==g.readyState){if(200==g.status&&(null!=g.responseXML&&null!=g.responseXML.documentElement)&&(g=g.responseXML.documentElement.getElementsByTagName("result"),0<g.length))if(g=g[0].getAttribute("recipe"),""==g)(!CPWbatch||!CPWbatch.cpw_get_batchjob_state())&&CPWbot_bg.alert("This url is not supported yet"),
CPWbot_bg.do_milestone(null,128,null,"no recipe");else{e(replace_constants(JSON.parse(g)));return}e(null)}},function(){e(null)})}function ping_ack_handler(g,e){var J=e.docnum,M=e.url,s=e.id,G=e.delta,Pa=(new Date).getTime()-e.timestamp;debug&&L("received ping response from [tabid:"+g+"][docnum:"+J+"][id:"+s+" sent: "+G+"ms, response: "+Pa+"ms docstate="+e.docstate+" url="+M);s=getcsinfo(g,J);s||(s=new CS_t,s.docnum=J,s.tabid=g);s.url=M;s.docstate=e.docstate;s.flags=e.flags;setcsinfo(g,J,s)}
function ping(g,e){var J=(new Date).getTime(),M=!1;if("undefined"==typeof g||null===g)M=!0;if("undefined"==typeof e||null===e)e="all";var s=("function"==typeof lp_sha256?lp_sha256:SHA256)(g_username+""+g+""+e+""+J);debug&&L("sending ping id="+s);if(M)for(g in g_CS)"undefined"!=typeof g&&null!==g&&sendCS(g,{cmd:"ping_req",id:s,timestamp:J},e);else sendCS(g,{cmd:"ping_req",id:s,timestamp:J},e)}
function cpwbot_getpwchangestate(){return g_cpwbot&&CPWbot_bg?"Bagration"==CPWbot_bg.get_pwchangestate()?!0===CPWbot_bg.get_failstate()?!0===CPWbot_bg.get_failpwsavedstate()?"FAIL_PW_SAVED":"FAIL":!0===CPWbot_bg.get_okstate()?"OK":null:!0===CPWbot_bg.get_captchastate()?"CAPTCHA":!0===CPWbot_bg.get_docaptchastate()?"DOCAPTCHA":!0===CPWbot_bg.get_brokenheartstate()?"TIMEOUT":"preinit"==CPWbot_bg.get_pwchangestate()?null:!0===CPWbot_bg.get_failstate()?!0===CPWbot_bg.get_failpwsavedstate()?"FAIL_PW_SAVED":
"FAIL":!0===CPWbot_bg.get_okstate()?"OK":CPWbot_bg.get_pwchangestate():"FAIL"}function cpwbot_preinit(){CPWbot_bg&&CPWbot_bg.preinit()}function cpwbot_get_user_debug_messages(){if(CPWbot_bg)return CPWbot_bg.get_user_debug_messages()}function cpwbot_get_dialog_msg(){if(CPWbot_bg)return CPWbot_bg.get_dialog_msg()}function cpwbot_halt(){if(CPWbot_bg)return CPWbot_bg.halt()}function cpwbot_minimize_dialog(){CPWbot_bg&&(CPWbot_bg.cpw_dialog_minimize_state=1)}
function cpwbot_maximize_dialog(){CPWbot_bg&&(CPWbot_bg.cpw_dialog_minimize_state=0)}function cpwbot_get_minimize_dialog_state(){if(CPWbot_bg)return CPWbot_bg.cpw_dialog_minimize_state};
